
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Demo SiAbDi</title>
    <link rel="icon" type="image/png" href="./imgsiabdi.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#738862', secondary: '#10B981', dark: '#111827', } } } }
  </script>

  <style>

        /* Mencegah zoom cubitan layar dan efek membal saat mentok */
html, body {
    touch-action: pan-y; 
    overscroll-behavior-y: none; }

/* Mencegah zoom otomatis saat mengklik kolom input / form */
input, button, select, textarea {
    touch-action: manipulation; 
    font-size: 16px !important; }


    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
    .animate-fade-in { animation: fadeIn 0.6s ease-out; }
    .animate-slide-up { animation: slideUp 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animated-gradient { background: linear-gradient(-45deg, #6366f1, #a855f7, #ec4899, #3b82f6); background-size: 400% 400%; animation: gradientMove 15s ease infinite; }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .glass-card { background: rgba(255, 255, 255, 0.25); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.4); }
    .view-section { display: none; }
    .view-section.active { display: block; }
    .judul-container { display: flex; align-items: center; gap: 10px; }
  </style>
</head>
<body class="bg-slate-50 font-sans antialiased text-slate-600 overflow-x-hidden">
  <div id="loginPage" class="relative min-h-screen flex items-center justify-center overflow-hidden animated-gradient">
    <div class="absolute top-0 left-0 w-96 h-96 bg-white/10 rounded-full mix-blend-overlay filter blur-3xl opacity-30 animate-pulse -translate-x-1/2 -translate-y-1/2"></div>
    <div class="absolute bottom-0 right-0 w-96 h-96 bg-pink-400/20 rounded-full mix-blend-overlay filter blur-3xl opacity-30 animate-pulse translate-x-1/2 translate-y-1/2"></div>

    <div class="w-full max-w-5xl flex flex-col lg:flex-row shadow-2xl rounded-3xl overflow-hidden z-10 mx-4 animate-fade-in glass-card">
        
        <div class="w-full lg:w-5/12 p-6 lg:p-12 flex flex-col justify-between relative text-white border-b lg:border-b-0 lg:border-r border-white/20 bg-white/10 backdrop-blur-md">
            
            <div class="relative z-10">
                <center>
                    <img src="" class="dyn-logo h-16 lg:h-20 w-auto max-w-full transition-all duration-300"> 
                </center>
                
                <div class="text-center mb-9 lg:mb-16 mt-3 lg:mt-0">
                    <center>
                        <h4 class="dyn-namasekolah text-xl lg:text-3xl font-bold leading-tight mb-0 text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 drop-shadow-sm">
                            Memuat...
                        </h4>
                    </center>
                    <br>
                    <center>
                        <span class="dyn-provinsi px-4 py-1.5 rounded-lg bg-white/10 backdrop-blur-md border border-white/10 text-xs lg:text-sm text-indigo-800 lg:text-indigo-600 font-bold">
                            ...
                        </span>
                    </center>
                </div> 

                <center>
                    <div class="judul-container flex items-center justify-center gap-2">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBg-h7yQ6aBqgL71tbuETsepWQpv0heHLgIeyhEQGz60PhLI1zk59riPeJoqxGoYzdB-bX4NQOI7ljmDPEOZkBgR14mgvw3p0gJv0q4VLiM26WfwRpAlrMVhLujlWqfUBPsaK84nYbJ6Sdi4oXwBEV5AzaBHvsgfFATXVBeV6M9zJTzd3LQzHylWrDTs5o/s425/logo%20siabdi%20ok.png" alt="Logo" class="w-8 lg:w-[50px] object-contain">
                        <h1 class="text-3xl lg:text-5xl font-bold leading-tight mb-0 text-transparent bg-clip-text bg-gradient-to-r from-white to-indigo-200 drop-shadow-sm mt-0"> SiAbDi </h1>
                    </div>
                    <p class="font-bold text-xs lg:text-sm text-white mt-1">Sistem Absensi Digital</p>
                </center>
                <br>

                <center>
                    <p class="text-indigo-100 text-xs lg:text-sm leading-relaxed max-w-xs opacity-90">
                        Platform sistem absensi digital sekolah yang modern dan real-time. Manajemen kehadiran siswa berbasis QR Code yang terintegrasi dan efisien.
                    </p>
                </center>
            </div>
            
            <div class="relative z-10 mt-6 lg:mt-10 flex justify-center gap-4 text-[10px] lg:text-xs font-medium text-black-200">
                <div class="px-3 py-1.5 rounded-lg bg-white/10 backdrop-blur-md border border-white/10 text-blue-800 lg:text-blue-600">
                <a href='#' class="dyn-website-link" rel='dofollow'><span class="dyn-website">Memuat...</span></a></div>
            </div>
        </div>

        <div class="w-full lg:w-7/12 p-6 lg:p-12 bg-white/40 backdrop-blur-xl flex items-center">
            <div class="w-full max-w-md mx-auto">
                <div class="text-center lg:text-left mb-6 lg:mb-10">
                    <center>
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBg-h7yQ6aBqgL71tbuETsepWQpv0heHLgIeyhEQGz60PhLI1zk59riPeJoqxGoYzdB-bX4NQOI7ljmDPEOZkBgR14mgvw3p0gJv0q4VLiM26WfwRpAlrMVhLujlWqfUBPsaK84nYbJ6Sdi4oXwBEV5AzaBHvsgfFATXVBeV6M9zJTzd3LQzHylWrDTs5o/s425/logo%20siabdi%20ok.png" class="w-12 lg:w-[70px] object-contain" >
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-900 mt-2" style="color:indigo;">Welcome to SiAbDi</h2>
                        <p class="text-gray-500 text-xs lg:text-sm mt-1">Silakan login ke akun Anda</p>
                    </center>
                </div>

                <div class="bg-gray-50 p-1.5 rounded-xl flex mb-6 lg:mb-8 border border-gray-100 relative">
                    <button id="btnSiswaTab" onclick="switchLoginTab('siswa')" class="flex-1 py-2.5 lg:py-3 text-sm font-bold rounded-lg shadow-sm bg-white text-indigo-600 ring-1 ring-black/5 transition-all duration-300 flex items-center justify-center gap-2"><i class="fas fa-user-graduate"></i> Siswa</button>
                    <button id="btnAdminTab" onclick="switchLoginTab('admin')" class="flex-1 py-2.5 lg:py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-all duration-300 flex items-center justify-center gap-2"><i class="fas fa-chalkboard-teacher"></i> Guru / Admin</button>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-4 lg:space-y-5">
                    <div id="formSiswaLogin" class="animate-fade-in">
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2 ml-1">NISN Siswa</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-600 transition-colors"><i class="far fa-id-card text-lg"></i></div>
                            <input type="number" id="nisn" class="block w-full pl-12 pr-4 py-3 lg:py-4 bg-gray-50 border-gray-200 border rounded-xl text-gray-900 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder-gray-400" placeholder="Masukkan NISN Anda (10 Angka)">
                        </div>
                    </div>
                    
                    <div id="formAdminLogin" class="hidden space-y-4 lg:space-y-5 animate-fade-in">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2 ml-1">Username</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-600 transition-colors"><i class="far fa-user text-lg"></i></div>
                                <input type="text" id="username" class="block w-full pl-12 pr-4 py-3 lg:py-4 bg-gray-50 border-gray-200 border rounded-xl text-gray-900 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder-gray-400" placeholder="Username">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2 ml-1">Password</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-600 transition-colors"><i class="fas fa-lock text-lg"></i></div>
                                <input type="password" id="password" class="block w-full pl-12 pr-10 py-3 lg:py-4 bg-gray-50 border-gray-200 border rounded-xl text-gray-900 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder-gray-400" placeholder="••••••••">
                                <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-600 focus:outline-none"><i class="fas fa-eye" id="togglePasswordIcon"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full py-3 lg:py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 hover:shadow-xl transition-all transform active:scale-[0.98] text-sm flex justify-center items-center gap-3"><span>LOGIN</span> <i class="fas fa-arrow-right-long"></i></button>
                </form>
                
                <div id="loginError" class="mt-6 hidden p-4 bg-rose-50 border border-rose-100 rounded-xl flex items-start gap-3 animate-fade-in">
                    <div class="p-2 bg-rose-100 rounded-full text-rose-600 shrink-0"><i class="fas fa-exclamation-triangle text-xs"></i></div>
                    <div><h4 class="text-sm font-bold text-rose-700">Akses Ditolak</h4><p id="errorText" class="text-xs text-rose-600 mt-0.5">Username atau password salah.</p></div>
                </div>
                <br><marquee class="dyn-runningtext px-3 py-1.5 rounded-lg bg-white/10 backdrop-blur-md border border-white/10" style='color:indigo;' >Memuat Pengumuman...</marquee>
            </div>
        </div>
        <br> <br> <br>
    </div>
      <footer class="absolute bottom-0 w-full z-20 px-6 py-4 border-t border-white/10 bg-black/5 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3 text-[10px] md:text-xs font-medium text-indigo-100/70">
            <div class="text-center md:text-left">
              <p>&copy; <span class="dyn-tahun"></span> <span class="text-white font-bold">SiAbDi</span> - <span class="dyn-namasekolah"></span>.<span class="hidden sm:inline">All Rights Reserved.</span></p>
            </div>

            <div class="flex items-center gap-4">
                <a href="#" onclick="showPrivacyModal(event)" class="hover:text-white transition-colors duration-300 hidden sm:block">Privacy Policy</a>
                <span class="hidden sm:block text-white/20">|</span>
                 <span class="flex items-center gap-1"> Dev by : <a href='https://www.fary-edtech.my.id' target="_blank" class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-white/10 hover:bg-white/20 text-white transition-all duration-300 group"> <span>Fary EdTech</span></a><a style="font-size: 5px;"> - Using Gemini AI</a>
                </span>
            </div>
        </div>
    </footer>
            
  </div>

  <div id="dashboardContainer" class="hidden flex h-screen overflow-hidden bg-[#F3F4F6]">
      <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 text-white transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out flex flex-col h-full shadow-2xl border-r border-indigo-900/30 overflow-hidden animated-gradient">
          <div id="sidebarHeader" class="h-16 flex items-center justify-start px-6 border-b border-indigo-900/50 overflow-hidden relative transition-all duration-300">
              <div class="flex items-center space-x-3 relative z-10 w-full"><div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-900/50 shrink-0 transition-all duration-300"><i class="fas fa-qrcode text-sm"></i></div><div class="sidebar-label transition-opacity duration-300 whitespace-nowrap"><h1 class="font-bold text-base tracking-wide text-white">SiAbDi</h1><p class="text-[9px] text-indigo-200 uppercase tracking-wider font-semibold">Sistem Absensi Digital</p></div></div>
          </div>
          <div class="p-4 overflow-hidden transition-all duration-300"><div id="userProfileCard" class="flex items-center space-x-3 p-3 bg-black/20 rounded-xl border border-white/10 transition-all duration-300 overflow-hidden"><div id="navUserInitial" class="w-8 h-8 rounded-lg bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center font-bold text-sm shadow-inner shrink-0 text-white">U</div><div id="userInfo" class="sidebar-label transition-opacity duration-300 whitespace-nowrap"><p id="navUserName" class="font-semibold text-xs truncate text-white max-w-[120px]">User</p><span id="navUserRole" class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold uppercase bg-indigo-800 text-indigo-100 border border-indigo-700 tracking-wider">Role</span></div></div></div>
          <nav id="sidebarMenu" class="flex-1 overflow-y-auto overflow-x-hidden px-3 space-y-1 pb-4 scrollbar-hide text-sm"></nav>
          <div class="p-4 border-t border-indigo-900/50 bg-black/10"><button onclick="logout()" id="btnLogout" class="flex items-center space-x-3 text-red-300 hover:text-white hover:bg-red-500/20 w-full p-2.5 rounded-lg transition duration-200 group overflow-hidden whitespace-nowrap justify-start"><i class="fas fa-sign-out-alt w-5 text-center shrink-0 group-hover:scale-110 transition-transform text-sm"></i><span class="sidebar-label font-medium transition-opacity duration-300 text-xs">Keluar Aplikasi</span></button></div>
      </aside>
      
      <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-30 hidden transition-opacity duration-300 opacity-0 pointer-events-none"></div>
      
      <main id="mainContent" class="flex-1 flex flex-col md:ml-64 h-screen relative transition-all duration-300 overflow-hidden bg-[#F3F4F6]">
          
          <header class="h-16 bg-white/80 backdrop-blur-xl sticky top-0 z-20 hidden md:flex items-center justify-between px-6 border-b border-slate-200/70 shadow-sm supports-[backdrop-filter]:bg-white/60">
              <div class="flex items-center">
                  <button onclick="toggleSidebar()" class="mr-3 p-1.5 text-slate-500 hover:bg-slate-100 hover:text-slate-800 rounded-lg transition-colors focus:outline-none">
                      <i class="fas fa-bars text-lg"></i>
                  </button>
                  <div><h2 id="pageTitle" class="text-lg font-bold text-slate-800 tracking-tight">Dashboard</h2></div>
              </div>
              <div class="flex items-center space-x-4">
                  <div class="text-right hidden md:block">
                      <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Hari ini</p>
                      <p class="text-xs font-bold text-slate-700" id="currentDateDisplay">...</p>
                  </div>
              </div>
          </header>

          <header id="mobileHeader" class="md:hidden fixed top-0 left-0 w-full z-40 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100 px-4 py-3 flex justify-between items-center transition-all">
              <div class="flex items-center gap-2">
                  <img src="" class="dyn-logo w-8 h-8 object-contain drop-shadow-sm transition-all duration-300">
                  <div class="leading-tight">
                      <h1 class="font-bold text-sm tracking-wide text-gray-800 m-0">SiAbDi</h1>
                      <p id="mobileHeaderRole" class="text-[9px] font-bold text-indigo-600 uppercase tracking-wider m-0">Role</p>
                  </div>
              </div>
              <div class="flex items-center gap-5">
                  <div id="mobileHeaderSchoolInfo" class="hidden flex-col items-end text-right">
                      <span class="dyn-namasekolah text-[11px] font-bold text-gray-800 leading-tight">Memuat...</span>
                      <span class="dyn-provinsi text-[8px] font-medium text-gray-500 leading-tight uppercase tracking-wider">...</span>
                  </div>
                  <button id="btnMobileLaporan" onclick="loadRekapAbsensi()" class="hidden flex-col items-center text-gray-500 hover:text-indigo-600">
                      <i class="fas fa-clipboard-list text-base"></i>
                      <span class="text-[8px] font-medium mt-0.5">Laporan</span>
                  </button>
                  <button id="btnMobileSettings" onclick="loadPengaturan()" class="hidden flex-col items-center text-gray-500 hover:text-indigo-600">
                      <i class="fas fa-cog text-base"></i>
                      <span class="text-[8px] font-medium mt-0.5">Setting</span>
                  </button>
                  <button id="btnMobileLogout" onclick="logout()" class="hidden flex-col items-center text-rose-500 hover:text-rose-600">
                      <i class="fas fa-sign-out-alt text-base"></i>
                      <span class="text-[8px] font-medium mt-0.5">Keluar</span>
                  </button>
              </div>
          </header>

          <nav id="mobileBottomNav" class="md:hidden fixed bottom-0 left-0 w-full z-40 bg-white border-t border-gray-200 shadow-[0_-10px_20px_-10px_rgba(0,0,0,0.1)] px-2 pb-1 pt-2 flex justify-around items-end">
              </nav>

          <div id="mainContentArea" class="flex-1 overflow-y-auto p-4 pt-20 pb-28 md:pt-4 md:pb-6 md:p-6 scroll-smooth">
              
              <div id="view-admin-dashboard" class="view-section animate-fade-in">
                  <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4"><div><h2 class="text-2xl font-bold text-gray-800 tracking-tight">Dashboard Admin</h2><p class="text-sm text-gray-500 mt-1">Manajemen absensi digital siswa.</p></div><div class="flex items-center gap-3"><span class="text-xs font-bold bg-white text-gray-600 px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm"><i class="far fa-clock mr-2"></i> <span id="adminDateDisplay">...</span></span><button onclick="refreshData('dashboard')" class="flex items-center space-x-2 text-xs font-bold text-white bg-indigo-600 border border-indigo-600 px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition transform active:scale-95"><i class="fas fa-sync-alt"></i> <span>Refresh Data</span></button></div></div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                      <div class="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 flex flex-col justify-between relative overflow-hidden group"><div class="absolute right-0 top-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Total Siswa</p><div class="flex items-center justify-between mt-2 relative z-10"><h3 id="admStatTotal" class="text-2xl font-bold text-gray-800">-</h3><div class="text-indigo-500 bg-indigo-50 p-2 rounded-lg"><i class="fas fa-users"></i></div></div></div>
                      <div class="bg-white p-5 rounded-xl shadow-sm border border-emerald-100 flex flex-col justify-between relative overflow-hidden group"><div class="absolute right-0 top-0 w-16 h-16 bg-emerald-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Hadir</p><div class="flex items-center justify-between mt-2 relative z-10"><h3 id="admStatHadir" class="text-2xl font-bold text-gray-800">-</h3><div class="text-emerald-500 bg-emerald-50 p-2 rounded-lg"><i class="fas fa-check"></i></div></div></div>
                      <div class="bg-white p-5 rounded-xl shadow-sm border border-yellow-100 flex flex-col justify-between relative overflow-hidden group"><div class="absolute right-0 top-0 w-16 h-16 bg-yellow-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Sakit</p><div class="flex items-center justify-between mt-2 relative z-10"><h3 id="admStatSakit" class="text-2xl font-bold text-gray-800">-</h3><div class="text-yellow-500 bg-yellow-50 p-2 rounded-lg"><i class="fas fa-procedures"></i></div></div></div>
                      <div class="bg-white p-5 rounded-xl shadow-sm border border-blue-100 flex flex-col justify-between relative overflow-hidden group"><div class="absolute right-0 top-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Izin</p><div class="flex items-center justify-between mt-2 relative z-10"><h3 id="admStatIzin" class="text-2xl font-bold text-gray-800">-</h3><div class="text-blue-500 bg-blue-50 p-2 rounded-lg"><i class="fas fa-paper-plane"></i></div></div></div>
                      <div class="bg-white p-5 rounded-xl shadow-sm border border-red-100 flex flex-col justify-between relative overflow-hidden group"><div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Alpa</p><div class="flex items-center justify-between mt-2 relative z-10"><h3 id="admStatAlpa" class="text-2xl font-bold text-gray-800">-</h3><div class="text-red-500 bg-red-50 p-2 rounded-lg"><i class="fas fa-times"></i></div></div></div>
                  </div>
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      <div class="lg:col-span-2 bg-white rounded-2xl p-6 border border-gray-100 shadow-sm"><div class="flex justify-between items-center mb-6"><h3 class="text-sm font-bold text-gray-700 flex items-center"><i class="fas fa-chart-bar text-indigo-500 mr-2"></i> Grafik Statistik Kehadiran</h3></div><div class="relative w-full h-[350px]"><canvas id="adminAttendanceChart"></canvas></div></div>
                      <div class="hidden lg:flex flex-col gap-4"><div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm h-full"><h3 class="font-bold text-gray-800 mb-4 flex items-center text-sm"><i class="fas fa-bolt text-amber-500 mr-2"></i> Akses Cepat</h3><div class="space-y-3"><button onclick="loadScanAbsensi()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-indigo-50 hover:border-indigo-200 transition-all group text-left"><div class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-qrcode"></i></div><div><div class="font-bold text-xs text-gray-700">Scan Absensi</div><div class="text-[10px] text-gray-400">Mode scanner kamera</div></div></button><button onclick="loadDataSiswa()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-blue-50 hover:border-blue-200 transition-all group text-left"><div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-user-graduate"></i></div><div><div class="font-bold text-xs text-gray-700">Data Siswa</div><div class="text-[10px] text-gray-400">Kelola database siswa</div></div></button><button onclick="loadRekapAbsensi()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-emerald-50 hover:border-emerald-200 transition-all group text-left"><div class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-file-alt"></i></div><div><div class="font-bold text-xs text-gray-700">Laporan</div><div class="text-[10px] text-gray-400">Export & rekap data</div></div></button><button onclick="loadKelolaAbsen()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-rose-50 hover:border-rose-200 transition-all group text-left"><div class="w-10 h-10 rounded-lg bg-rose-100 text-rose-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-calendar-times"></i></div><div><div class="font-bold text-xs text-gray-700">Hari Libur</div><div class="text-[10px] text-gray-400">Setting tanggal merah</div></div></button></div></div></div>
                  </div>
              </div>

              <div id="view-pengaturan" class="view-section animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-5 border-b border-gray-100 bg-gray-50/50"><h3 class="font-bold text-gray-800"><i class="fas fa-sliders-h text-indigo-600 mr-2"></i> Pengaturan Umum</h3><p class="text-xs text-gray-500 mt-1">Ubah data identitas sekolah.</p></div><div class="p-5"><form onsubmit="saveLinkData(event)"><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-700 mb-1">Nama Sekolah</label><input type="text" name="namasekolah" class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Provinsi</label><input type="text" name="provinsi" class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Tahun Ajaran</label><input type="text" name="tahun" class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div>
                
               <div>
              <label class="block text-xs font-bold text-gray-700 mb-1">Logo Sekolah (Upload & Crop 1:1)</label>
               <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <img id="previewLogoSetting" src="" class="w-14 h-14 rounded-lg border border-gray-300 object-contain bg-white shadow-sm" alt="Logo">
                  <div class="flex-1">
                   <input type="file" id="inputLogoFile" accept="image/png, image/jpeg, image/jpg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 transition">
                   <p class="text-[9px] text-gray-400 mt-1.5 font-medium leading-tight">Pilih gambar untuk di-crop 1:1. Otomatis menjadi PNG transparan.</p>
               </div>
                  </div>
              <input type="hidden" name="logo" id="finalLogoData">
              </div>
                
                <div><label class="block text-xs font-bold text-gray-700 mb-1">Website</label><input type="text" name="website" class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Running Text</label><textarea name="runningtext" class="w-full border-gray-300 rounded-lg text-sm p-2.5" rows="2"></textarea></div></div><button type="submit" id="btnSaveLink" class="w-full mt-6 bg-indigo-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 transition">Simpan Perubahan</button></form></div></div><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-fit"><div class="p-5 border-b border-gray-100 bg-gray-50/50"><h3 class="font-bold text-gray-800"><i class="fas fa-lock text-rose-600 mr-2"></i> Keamanan Akun</h3><p class="text-xs text-gray-500 mt-1">Ganti password administrator.</p></div><div class="p-5"><form onsubmit="changeAdminPass(event)"><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-700 mb-1">Password Lama</label><input type="password" name="oldPass" required class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Password Baru</label><input type="password" name="newPass" required class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div></div><button type="submit" id="btnChangePass" class="w-full mt-6 bg-rose-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-rose-700 transition">Update Password</button></form></div></div></div></div>

                

              <div id="view-guru-dashboard" class="view-section animate-fade-in"><div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4"><div><h2 class="text-2xl font-bold text-gray-800 tracking-tight">Dashboard Guru</h2><p class="text-sm text-gray-500 mt-1">Ringkasan aktivitas siswa hari ini.</p></div><div class="flex items-center gap-3"><span class="text-xs font-bold bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg border border-indigo-100"><i class="far fa-calendar-alt mr-2"></i> <span id="guruDashboardDate">...</span></span><button onclick="refreshData('dashboard')" class="flex items-center space-x-2 text-xs font-bold text-gray-600 bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 transition"><i class="fas fa-sync-alt"></i> <span>Refresh</span></button></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 group hover:shadow-md transition-all"><div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div><div class="relative z-10 flex flex-col h-full justify-between"><div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm"><i class="fas fa-user-graduate"></i></div><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Siswa</p><h3 id="statGuruTotal" class="text-3xl font-bold text-gray-800 mt-1">-</h3></div></div></div><div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 group hover:shadow-md transition-all"><div class="absolute top-0 right-0 w-24 h-24 bg-yellow-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div><div class="relative z-10 flex flex-col h-full justify-between"><div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm"><i class="fas fa-procedures"></i></div><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Sakit</p><h3 id="statGuruSakit" class="text-3xl font-bold text-gray-800 mt-1">-</h3></div></div></div><div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-blue-100 group hover:shadow-md transition-all"><div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div><div class="relative z-10 flex flex-col h-full justify-between"><div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm"><i class="fas fa-envelope-open-text"></i></div><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Izin</p><h3 id="statGuruIzin" class="text-3xl font-bold text-gray-800 mt-1">-</h3></div></div></div><div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-red-100 group hover:shadow-md transition-all"><div class="absolute top-0 right-0 w-24 h-24 bg-red-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div><div class="relative z-10 flex flex-col h-full justify-between"><div class="w-12 h-12 bg-red-100 text-red-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm"><i class="fas fa-times-circle"></i></div><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Alpa</p><h3 id="statGuruAlpa" class="text-3xl font-bold text-gray-800 mt-1">-</h3></div></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white rounded-2xl p-6 border border-gray-100 shadow-sm"><h3 class="text-sm font-bold text-gray-700 mb-6 flex items-center justify-between"><span><i class="fas fa-chart-bar text-indigo-500 mr-2"></i> Statistik Kehadiran Hari Ini</span><span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">Realtime</span></h3><div class="relative w-full h-[300px]"><canvas id="guruAttendanceChart"></canvas></div></div>
              <div class="hidden lg:flex bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden flex-col justify-center items-center text-center"><div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div><div class="relative z-10"><div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-2xl mb-4 mx-auto border border-white/20"><i class="fas fa-qrcode"></i></div><h3 class="text-lg font-bold mb-2">Mulai Absensi</h3><p class="text-indigo-100 text-xs mb-6 px-4">Buka pemindai kamera untuk melakukan absensi siswa secara cepat.</p><button onclick="loadScanAbsensi()" class="bg-white text-indigo-700 px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-gray-50 transition transform active:scale-95 w-full">Buka Scanner</button></div></div></div></div>

              <div id="view-siswa-dashboard" class="view-section animate-fade-in"><div class="flex justify-end mb-4"><button onclick="refreshData('dashboard')" class="flex items-center space-x-2 text-xs font-bold text-indigo-600 bg-white border border-indigo-100 px-3 py-1.5 rounded-lg shadow-sm hover:bg-indigo-50 transition"><i class="fas fa-sync-alt"></i> <span>Refresh</span></button></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto"><div class="lg:col-span-2 space-y-6"><div id="heroCard" class="relative overflow-hidden rounded-3xl bg-slate-800 p-6 text-white shadow-xl shadow-slate-200 transition-all duration-500 group"><div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl transition-transform duration-700 group-hover:scale-110"></div><div class="relative z-10"><div class="flex justify-between items-start mb-6"><div><p id="dashDate" class="text-slate-300 text-[10px] font-bold tracking-widest uppercase mb-1">...</p><h2 class="text-3xl font-bold tracking-tight mb-1">Hai, <span id="dashGreeting">Siswa</span></h2><p class="text-slate-400 text-xs">Semoga harimu menyenangkan!</p></div><div id="dashStatusBadge" class="px-4 py-2 rounded-xl bg-white/10 backdrop-blur-md border border-white/10 text-white text-xs font-bold shadow-sm">Memuat...</div></div><div class="grid grid-cols-2 gap-4 mt-4"><div class="bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10"><div class="flex items-center gap-2 mb-2 text-slate-300"><i class="fas fa-sign-in-alt text-xs"></i><span class="text-[10px] uppercase font-bold tracking-wider">Jam Datang</span></div><div id="valMasuk" class="font-mono text-2xl font-bold tracking-tight">--:--</div></div><div class="bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10"><div class="flex items-center gap-2 mb-2 text-slate-300"><i class="fas fa-sign-out-alt text-xs"></i><span class="text-[10px] uppercase font-bold tracking-wider">Jam Pulang</span></div><div id="valPulang" class="font-mono text-2xl font-bold tracking-tight">--:--</div></div></div></div></div><div id="alertBelumAbsen" class="hidden bg-rose-50 border border-rose-100 rounded-xl p-4 flex gap-3 items-start shadow-sm"><div class="bg-white p-2 rounded-full text-rose-500 shadow-sm"><i class="fas fa-exclamation"></i></div><div><h4 class="text-sm font-bold text-rose-800 mb-0.5">Peringatan Absensi</h4><p class="text-xs font-medium text-rose-600/80 leading-relaxed">Anda belum melakukan scan absensi datang hari ini. Harap segera lakukan absensi.</p></div></div></div><div class="space-y-6"><div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 text-center relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500"></div><div class="relative z-10 -mt-2"><div class="w-20 h-20 bg-white p-1 rounded-full mx-auto shadow-md"><div class="w-full h-full bg-slate-100 rounded-full flex items-center justify-center text-3xl text-slate-300"><i class="fas fa-user"></i></div></div><h3 id="profileNameSidebar" class="font-bold text-slate-800 text-lg mt-3 truncate">Nama Siswa</h3><p id="profileNisnSidebar" class="text-xs font-mono text-slate-500 bg-slate-100 inline-block px-2 py-1 rounded mt-1">1234567890</p><div class="grid grid-cols-2 gap-2 mt-4 text-left"><div class="bg-slate-50 p-2 rounded-lg border border-slate-100"><p class="text-[10px] text-slate-400 uppercase font-bold">Kelas</p><p id="profileKelasSidebar" class="text-sm font-bold text-slate-700">-</p></div><div class="bg-slate-50 p-2 rounded-lg border border-slate-100"><p class="text-[10px] text-slate-400 uppercase font-bold">Status</p><p class="text-sm font-bold text-emerald-600">Aktif</p></div></div></div></div>
              <button onclick="loadQRCodeSiswa()" class="hidden md:block w-full group relative overflow-hidden rounded-2xl bg-slate-900 p-1 shadow-lg shadow-slate-900/10 transition-all active:scale-[0.98]">
              <div class="relative bg-slate-900 rounded-[0.9rem] px-5 py-4 flex items-center justify-between transition-all group-hover:bg-slate-800"><div class="text-left"><h3 class="text-white font-bold text-sm">Kartu Absensi Digital</h3><p class="text-slate-400 text-[10px]">Tampilkan QR Code</p></div><div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-white text-lg"><i class="fas fa-qrcode"></i></div></div></button></div></div></div>

              <div id="view-data-siswa" class="view-section animate-fade-in"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/30"><div><h3 class="font-bold text-sm text-gray-800">Direktori Siswa</h3></div>
              <div class="flex flex-wrap items-center gap-2 justify-end">
    <button onclick="refreshData('siswa')" class="bg-white text-gray-600 border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 transition"><i class="fas fa-sync-alt"></i></button>
    <button onclick="showImportSiswaModal()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-emerald-700 transition"><i class="fas fa-file-excel"></i> <span class="hidden sm:inline ml-1">Import</span></button>
    <button onclick="showAddSiswaModal()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-indigo-700 transition"><i class="fas fa-plus"></i> <span class="hidden sm:inline ml-1">Tambah</span></button></div>
              
              </div>
              
              <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4"><div class="flex flex-col sm:flex-row items-center gap-3 text-xs w-full md:w-auto"><div class="flex items-center gap-2 w-full sm:w-auto"><span class="text-gray-500 font-bold whitespace-nowrap">Show</span><select onchange="handleTableLimit('siswa', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full sm:w-auto"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option><option value="all">Semua</option></select></div><select id="filterKelasSiswa" onchange="handleTableClassFilter('siswa', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full sm:w-40 font-bold shadow-sm"><option value="">Semua Kelas</option></select></div><div class="relative w-full md:w-64"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400 text-xs"></i></div><input type="text" oninput="handleTableSearch('siswa', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2 transition-all" placeholder="Cari Nama / NISN..."></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold"><tr><th class="p-3 text-center w-10">No</th><th class="p-3">Nama</th><th class="p-3">NISN</th><th class="p-3">Kelas</th><th class="p-3 text-center">Aksi</th></tr></thead><tbody id="tbody-siswa" class="divide-y divide-gray-50 bg-white text-xs"></tbody></table></div><div id="footer-siswa" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500"><span id="info-siswa">Menampilkan 0 data</span><div class="flex gap-1"><button onclick="changePage('siswa', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-prev-siswa">Prev</button><button onclick="changePage('siswa', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-next-siswa">Next</button></div></div></div></div>

              <div id="view-data-guru" class="view-section animate-fade-in"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/30"><div><h3 class="font-bold text-sm text-gray-800">Manajemen Guru</h3></div>
              <div class="flex flex-wrap items-center gap-2 justify-end">
    <button onclick="refreshData('guru')" class="bg-white text-gray-600 border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 transition"><i class="fas fa-sync-alt"></i></button>
    <button onclick="showImportGuruModal()" class="bg-teal-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-teal-700 transition"><i class="fas fa-file-excel"></i> <span class="hidden sm:inline ml-1">Import</span></button>
    <button onclick="showAddGuruModal()" class="bg-purple-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-purple-700 transition"><i class="fas fa-plus"></i> <span class="hidden sm:inline ml-1">Tambah</span></button></div>
                </div>
                
                <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4"><div class="flex flex-col sm:flex-row items-center gap-3 text-xs w-full md:w-auto"><div class="flex items-center gap-2"><span class="text-gray-500 font-bold">Show</span><select onchange="handleTableLimit('guru', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="all">Semua</option></select></div><select id="filterKelasGuru" onchange="handleTableClassFilter('guru', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2 w-full sm:w-40 font-bold shadow-sm"><option value="">Semua Kelas</option></select></div><div class="relative w-full md:w-64"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400 text-xs"></i></div><input type="text" oninput="handleTableSearch('guru', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full pl-10 p-2" placeholder="Cari Username..."></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold"><tr><th class="p-3 text-center w-10">No</th><th class="p-3">Username</th><th class="p-3">Wali Kelas</th><th class="p-3">Password</th><th class="p-3 text-center">Aksi</th></tr></thead><tbody id="tbody-guru" class="divide-y divide-gray-50 bg-white text-xs"></tbody></table></div><div id="footer-guru" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500"><span id="info-guru">Menampilkan 0 data</span><div class="flex gap-1"><button onclick="changePage('guru', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-prev-guru">Prev</button><button onclick="changePage('guru', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-next-guru">Next</button></div></div></div></div>

              <div id="view-kelola-absen" class="view-section animate-fade-in"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-24"><div class="p-5 border-b border-gray-100 bg-indigo-50/50"><h3 class="font-bold text-gray-800 flex items-center"><i class="fas fa-clock text-indigo-600 mr-2"></i> Pengaturan Waktu</h3><p class="text-xs text-gray-500 mt-1">Konfigurasi jam operasional absensi.</p></div><div class="p-5"><form onsubmit="saveGlobalConfig(event)"><div class="space-y-4"><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><p class="text-[10px] uppercase font-bold text-gray-400 mb-2">Absen Datang</p><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-700 mb-1">Mulai Buka</label><input type="time" id="conf_masuk_mulai" name="jam_masuk_mulai" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Batas Terlambat</label><input type="time" id="conf_masuk_akhir" name="jam_masuk_akhir" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500"></div></div><p class="text-[10px] text-orange-500 mt-1.5"><i class="fas fa-info-circle"></i> Lewat batas ini status: <b>Terlambat</b></p></div><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><p class="text-[10px] uppercase font-bold text-gray-400 mb-2">Absen Pulang</p><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-700 mb-1">Mulai Buka</label><input type="time" id="conf_pulang_mulai" name="jam_pulang_mulai" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Tutup Absen</label><input type="time" id="conf_pulang_akhir" name="jam_pulang_akhir" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500"></div></div><p class="text-[10px] text-orange-500 mt-1.5"><i class="fas fa-info-circle"></i> Pulang sebelum dibuka: <b>Pulang Cepat</b></p></div></div><button type="submit" id="btnSaveConfig" class="w-full mt-5 bg-indigo-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 transition transform active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-save"></i> Simpan Pengaturan</button></form></div></div></div><div class="lg:col-span-2"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-5 border-b border-gray-100 bg-gray-50/30 flex justify-between items-end"><div><h3 class="font-bold text-gray-800">Daftar Hari Libur</h3><p class="text-xs text-gray-500 mt-1">Siswa tidak bisa absen pada tanggal ini.</p></div></div><div class="p-5 border-b border-gray-100"><form onsubmit="handleAddLibur(event)" class="flex flex-col md:flex-row gap-3 items-end"><div class="flex-1 w-full"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tanggal</label><input type="date" name="tanggal" required class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div><div class="flex-[2] w-full"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Keterangan</label><input type="text" name="keterangan" required placeholder="Contoh: Maulid Nabi / Cuti Bersama" class="w-full border-gray-300 rounded-lg text-sm p-2.5"></div><button type="submit" class="bg-emerald-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-emerald-700 transition w-full md:w-auto"><i class="fas fa-plus mr-1"></i> Tambah</button></form></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold"><tr><th class="p-4 w-10 text-center">No</th><th class="p-4">Tanggal</th><th class="p-4">Keterangan</th><th class="p-4 text-center w-20">Aksi</th></tr></thead><tbody id="tbody-libur" class="divide-y divide-gray-50 text-sm"></tbody></table></div><div id="footer-libur" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500"><span id="info-libur">Menampilkan 0 data</span><div class="flex gap-1"><button onclick="changePage('libur', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-prev-libur">Prev</button><button onclick="changePage('libur', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-next-libur">Next</button></div></div></div></div></div></div>

              <div id="view-monitoring" class="view-section animate-fade-in"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 bg-gray-50/30">
    <div>
        <h3 class="font-bold text-sm text-gray-800 mb-1">Monitoring Kehadiran</h3>
        <p class="text-xs text-gray-500 font-medium">Data Realtime: <span id="monitoringDate" class="text-indigo-600 font-bold">...</span></p>
    </div>
              
    <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-start md:justify-end mt-2 md:mt-0">
        <input type="date" id="tgl_export_harian" 
               class="flex-1 md:flex-none border border-gray-300 text-gray-600 px-2 py-1.5 rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
               title="Pilih Tanggal untuk Download">

        <button onclick="processDailyExportCustom(this)" id="btnExportMonitoring" 
                class="flex-1 md:flex-none justify-center bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-emerald-700 transition flex items-center gap-2">
            <i class="fas fa-file-excel"></i> 
            <span class="hidden sm:inline">Export Excel</span>
        </button>
          
        <button onclick="showMatrixModal()" 
                class="flex-1 md:flex-none justify-center bg-purple-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-purple-700 transition flex items-center gap-2">
            <i class="fas fa-th"></i> 
            <span class="hidden sm:inline">Matriks</span>
        </button>

        <button onclick="refreshData('monitoring')" 
                class="bg-white text-gray-600 border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 transition" 
                title="Perbarui Data">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>
              
              <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4"><div class="flex flex-col sm:flex-row items-center gap-2 text-xs w-full md:w-auto"><div class="flex items-center gap-2 w-full sm:w-auto"><span class="text-gray-500 font-bold hidden sm:inline">Show</span><select onchange="handleTableLimit('monitoring', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full sm:w-auto"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="all">Semua</option></select></div><select onchange="handleTableStatusFilter('monitoring', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 font-bold w-full sm:w-auto shadow-sm"><option value="">Semua Status</option><option value="Hadir">Hadir (Hijau)</option><option value="Sakit">Sakit (Kuning)</option><option value="Izin">Izin (Biru)</option><option value="Alpa">Alpa (Merah)</option><option value="Belum Absen">Belum Absen (Abu)</option></select></div><div class="relative w-full md:w-64"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400 text-xs"></i></div><input type="text" oninput="handleTableSearch('monitoring', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2 transition-all" placeholder="Cari Nama / Kelas..."></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold"><tr><th class="p-4 text-center w-10">No</th><th class="p-4">Siswa</th><th class="p-4 text-center">Kelas</th><th class="p-4 text-center">Jam Datang</th><th class="p-4 text-center">Jam Pulang</th><th class="p-4 text-center">Keterangan Waktu</th><th class="p-4 text-center">Status Kehadiran</th></tr></thead><tbody id="tbody-monitoring" class="divide-y divide-gray-50 bg-white text-sm"></tbody></table></div><div id="footer-monitoring" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500"><span id="info-monitoring">Menampilkan 0 data</span><div class="flex gap-1"><button onclick="changePage('monitoring', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-prev-monitoring">Prev</button><button onclick="changePage('monitoring', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-next-monitoring">Next</button></div></div></div></div>

              <div id="view-rekap-absensi" class="view-section animate-fade-in"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-5 border-b border-gray-100 bg-gray-50/50"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4"><div><h3 class="font-bold text-lg text-gray-800">Laporan Kehadiran</h3><p class="text-xs text-gray-500">Rekap data absensi siswa berdasarkan periode.</p></div></div><div class="flex flex-col md:flex-row gap-3 items-end bg-white p-4 rounded-xl border border-gray-200 shadow-sm"><div class="w-full md:flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Dari Tanggal</label><input type="date" id="fStart" class="w-full border-gray-300 rounded-lg text-xs p-2.5 focus:ring-indigo-500 focus:border-indigo-500"></div><div class="w-full md:flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Sampai Tanggal</label><input type="date" id="fEnd" class="w-full border-gray-300 rounded-lg text-xs p-2.5 focus:ring-indigo-500 focus:border-indigo-500"></div><div class="w-full md:flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Filter Kelas</label><select id="fKelasRekap" class="w-full border-gray-300 rounded-lg text-xs p-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white"><option value="">Semua Kelas</option></select></div><div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto mt-2 md:mt-0"><button onclick="applyFilter()" class="flex-1 md:flex-none bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold text-xs shadow-md hover:bg-indigo-700 transition transform active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-search"></i> Cari Data</button><button onclick="exportToExcel()" id="btnExportExcel" class="flex-1 md:flex-none bg-emerald-600 text-white px-5 py-2.5 rounded-lg font-bold text-xs shadow-md hover:bg-emerald-700 transition transform active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-file-excel"></i> Export Excel</button><button onclick="showMatrixModal()" class="flex-1 md:flex-none bg-purple-600 text-white px-5 py-2.5 rounded-lg font-bold text-xs shadow-md hover:bg-purple-700 transition transform active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-th"></i> Mode Matriks</button></div></div></div><div id="rekapContainer" class="hidden"><div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4"><div class="flex items-center gap-2 text-xs"><span class="text-gray-500 font-bold">Tampilkan</span><select onchange="handleTableLimit('rekap', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="all">Semua</option></select></div><div class="relative w-full md:w-64"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400 text-xs"></i></div><input type="text" oninput="handleTableSearch('rekap', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2" placeholder="Cari Siswa / Kelas..."></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold"><tr><th class="p-4 text-center w-10">No</th><th class="p-4">Tanggal</th><th class="p-4">Nama Siswa</th><th class="p-4 text-center">Kelas</th><th class="p-4 text-center">Jam Datang</th><th class="p-4 text-center">Jam Pulang</th><th class="p-4 text-center">Keterangan Waktu</th><th class="p-4 text-center">Status</th></tr></thead><tbody id="tbody-rekap" class="bg-white divide-y divide-gray-50 text-sm"></tbody></table></div><div id="footer-rekap" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500"><span id="info-rekap">Menampilkan 0 data</span><div class="flex gap-1"><button onclick="changePage('rekap', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-prev-rekap">Prev</button><button onclick="changePage('rekap', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-next-rekap">Next</button></div></div></div><div id="rekapEmptyState" class="text-center p-16 flex flex-col items-center justify-center"><div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-200 mb-4 text-4xl"><i class="fas fa-calendar-alt"></i></div><h4 class="font-bold text-gray-800 text-lg">Menunggu Filter</h4><p class="text-gray-500 text-sm mt-1 max-w-xs mx-auto">Silakan pilih rentang tanggal mulai dan akhir, lalu klik tombol <b>Cari Data</b>.</p></div><div id="rekapLoading" class="hidden text-center p-16 flex flex-col items-center justify-center"><div class="w-16 h-16 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div><h4 class="font-bold text-gray-800">Sedang Memproses...</h4><p class="text-gray-500 text-xs mt-1">Mengambil data dari server</p></div></div></div>

              <div id="view-scanner" class="view-section animate-fade-in"><div class="max-w-xs mx-auto"><div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden"><div class="p-4 bg-gray-900 text-white text-center"><h3 class="font-bold text-lg tracking-wide">Scanner</h3></div><div class="p-4"><div class="relative w-full aspect-square bg-black rounded-xl overflow-hidden mb-4 shadow-inner"><div id="reader" class="w-full h-full object-cover"></div><div id="camLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-20"><i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-indigo-500"></i><p class="text-xs font-medium text-white">Memuat...</p></div></div><div id="scanResult" class="hidden mb-4 text-center text-xs font-bold animate-fade-in"></div><div class="flex gap-2 mb-2"><button onclick="startCamera('environment')" class="flex-1 bg-blue-50 text-blue-700 py-2 rounded-lg font-bold text-xs hover:bg-blue-100">Belakang</button><button onclick="startCamera('user')" class="flex-1 bg-purple-50 text-purple-700 py-2 rounded-lg font-bold text-xs hover:bg-purple-100">Depan</button></div><button onclick="stopAndBack(true)" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-bold text-xs hover:bg-gray-200">Kembali</button></div></div></div></div>

              <div id="view-kartu-siswa" class="view-section animate-fade-in"><div id="kartuSiswaContainer"></div></div>

              <div id="view-rekap-siswa" class="view-section animate-fade-in">
                  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                      <div class="p-5 border-b border-gray-100 bg-gray-50/50">
                          <h3 class="font-bold text-lg text-gray-800">Rekap Absensi Bulanan</h3>
                          <p class="text-xs text-gray-500">Lihat dan unduh laporan kehadiran Anda (PDF).</p>
                      </div>
                      <div class="p-5">
                          <div class="flex flex-col sm:flex-row gap-3 items-end mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
                              <div class="w-full sm:flex-1">
                                  <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Bulan</label>
                                  <select id="rs_bulan" class="w-full border-gray-300 rounded-lg text-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white"></select>
                              </div>
                              <div class="w-full sm:flex-1">
                                  <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tahun</label>
                                  <input type="number" id="rs_tahun" class="w-full border-gray-300 rounded-lg text-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                              </div>
                              <button onclick="cariRekapSiswa()" class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold text-xs shadow-md hover:bg-indigo-700 transition transform active:scale-95 flex items-center justify-center gap-2">
                                  <i class="fas fa-search"></i> Cari Data
                              </button>
                          </div>

                          <div id="rs_result" class="hidden">
                              <div class="flex justify-between items-center mb-4">
                                  <h4 class="font-bold text-gray-700 text-sm">Hasil Rekap</h4>
                                  <button onclick="downloadPDFRekapSiswa()" id="btnDownloadPDFSiswa" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-rose-600 transition flex items-center gap-2 transform active:scale-95">
                                      <i class="fas fa-file-pdf"></i> Unduh PDF
                                  </button>
                              </div>
                              <div class="overflow-x-auto border border-gray-200 rounded-xl">
                                  <table class="w-full text-left">
                                      <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold">
                                          <tr><th class="p-3 text-center">Tgl/Hari</th><th class="p-3 text-center">Status</th><th class="p-3">Keterangan</th></tr>
                                      </thead>
                                      <tbody id="tbody-rekap-siswa" class="divide-y divide-gray-100 text-xs bg-white"></tbody>
                                  </table>
                              </div>
                          </div>
                          <div id="rs_loading" class="hidden p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2 text-indigo-500"></i><p class="text-xs font-bold mt-2">Memuat data...</p></div>
                      </div>
                  </div>

                  <div class="fixed top-0 left-0 z-[-10] opacity-0 pointer-events-none overflow-hidden" style="width: 0; height: 0;">
                      <div id="printAreaRekapSiswa" class="bg-white text-black p-8" style="width: 800px; min-height: 1123px; position: absolute; left: 0; top: 0; font-family: 'Arial Narrow', serif;">
                          <div style="display: flex; align-items: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 25px;">
                              <img id="printLogoSiswa" src="" style="width: 80px; height: 80px; object-fit: contain;">
                              <div style="flex: 1; text-align: center;">
                                  <h2 id="printNamaSekolah" style="margin: 0; font-size: 22px; font-weight: bold; text-transform: uppercase;">MEMUAT SEKOLAH...</h2>
                                  <p id="printProvinsi" style="margin: 5px 0 0 0; font-size: 14px; text-transform: uppercase;">PROVINSI...</p>
                              </div>
                              <div style="width: 80px;"></div> </div>
                          <div style="text-align: center; margin-bottom: 25px;">
                              <h3 style="margin: 0; font-size: 16px; font-weight: bold; text-decoration: underline;">REKAP ABSENSI SISWA</h3>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px;">
                              <div>
                                  <table style="border: none;">
                                      <tr><td style="padding: 3px 15px 3px 0;">Nama</td><td style="padding: 3px;">: <span id="printSiswaNama" style="font-weight: bold;">-</span></td></tr>
                                      <tr><td style="padding: 3px 15px 3px 0;">NISN</td><td style="padding: 3px;">: <span id="printSiswaNISN">-</span></td></tr>
                                  </table>
                              </div>
                              <div>
                                  <table style="border: none;">
                                      <tr><td style="padding: 3px 15px 3px 0;">Kelas</td><td style="padding: 3px;">: <span id="printSiswaKelas" style="font-weight: bold;">-</span></td></tr>
                                      <tr><td style="padding: 3px 15px 3px 0;">Periode</td><td style="padding: 3px;">: <span id="printSiswaPeriode">-</span></td></tr>
                                  </table>
                              </div>
                          </div>
                          <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px;">
                              <thead>
                                  <tr style="background-color: #f3f4f6;">
                                      <th style="border: 1px solid #000; padding: 10px; width: 40px; text-align: center;">No</th>
                                      <th style="border: 1px solid #000; padding: 10px; width: 150px; text-align: center;">Tanggal / Hari</th>
                                      <th style="border: 1px solid #000; padding: 10px; width: 100px; text-align: center;">Status</th>
                                      <th style="border: 1px solid #000; padding: 10px;">Keterangan</th>
                                  </tr>
                              </thead>
                              <tbody id="printTbodyRekapSiswa"></tbody>
                          </table>
                      </div>
                  </div>
              </div>

             <footer class="mt-10 pt-6 border-t border-gray-200">
                  <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-gray-500">
                      
                      <div class="text-center md:text-left">
                          <p class="font-semibold text-gray-700">© <span class="dyn-tahun"></span> SiAbDi - <span class="dyn-namasekolah"></span></p>
                          <p class="mt-1">Sistem Absensi Digital | All Rights Reserved.</p>
                      </div>

                      <div class="flex items-center gap-4">
                          <a href="https://wa.me/6285219901909" target="_blank" class="hover:text-indigo-600 transition">Bantuan</a>
                          <span class="text-gray-300">|</span>
                          <a href="#" onclick="showPrivacyModal(event)" class="hover:text-indigo-600 transition">Kebijakan Privasi</a>
                          <span class="text-gray-300">|</span>
                          
                          <span class="opacity-75">Dev by :
                              <a href='https://www.fary-edtech.my.id' target="_blank" class="text-indigo-600 font-bold hover:underline">Fary EdTech</a>
                          </span>
                      </div>
                  </div>
                  <div class="h-6"></div> 
              </footer>

          </div> 
          <button id="btnScrollTop" onclick="scrollToTop()" class="fixed bottom-24 md:bottom-6 right-6 z-50 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg shadow-indigo-500/40 hover:bg-indigo-700 hover:scale-110 transition-all duration-300 flex items-center justify-center opacity-0 translate-y-10 invisible group">
              <i class="fas fa-arrow-up text-lg group-hover:-translate-y-1 transition-transform"></i> </button>

      </main>
  </div>


  <div id="cropModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity" onclick="closeCropModal()"></div>
      <div class="relative bg-white rounded-3xl shadow-2xl p-6 max-w-md w-full animate-slide-up">
          <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-crop-alt text-indigo-600 mr-2"></i> Sesuaikan Logo</h3>
              <button onclick="closeCropModal()" class="text-gray-400 hover:text-rose-500 transition"><i class="fas fa-times text-lg"></i></button>
          </div>
          <div class="w-full h-64 bg-gray-100 flex items-center justify-center overflow-hidden rounded-xl mb-6 shadow-inner border border-gray-200">
              <img id="imageToCrop" src="" style="max-width: 100%; max-height: 100%; display: block;">
          </div>
          <div class="flex gap-3">
              <button onclick="closeCropModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Batal</button>
              <button onclick="applyCrop()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">Terapkan PNG</button>
          </div>
      </div>
  </div>

 <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[9999] hidden flex items-center justify-center flex-col transition-opacity pointer-events-none">
      <div class="p-6 bg-white rounded-3xl shadow-2xl flex flex-col items-center min-w-[160px] transform scale-110">
          <div class="w-14 h-14 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4 relative flex items-center justify-center">
              <div class="absolute inset-0 flex items-center justify-center animate-[spin_1s_linear_infinite_reverse]">
                  <span id="loadingCountdown" class="text-xs font-extrabold text-indigo-600">8</span>
              </div>
          </div>
          <p id="loadingText" class="text-slate-800 text-sm font-bold tracking-wide text-center leading-tight">Memproses... <br><span class="text-[10px] text-gray-500 font-normal">Mohon tunggu</span></p>
      </div>
  </div>

  <div id="modalContainer"></div>

  <div id="privacyModal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/75 transition-opacity backdrop-blur-sm" onclick="closePrivacyModal()"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl animate-fade-in border border-gray-100">
                
                <div class="bg-indigo-600 px-4 py-4 sm:px-6 flex justify-between items-center">
                    <h3 class="text-base font-bold leading-6 text-white flex items-center gap-2" id="modal-title">
                        <i class="fas fa-shield-alt"></i> Kebijakan Privasi
                    </h3>
                    <button type="button" onclick="closePrivacyModal()" class="text-indigo-200 hover:text-white transition">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <div class="px-6 py-6 max-h-[60vh] overflow-y-auto text-sm text-gray-600 leading-relaxed space-y-4">
                    <p class="font-bold text-gray-800">Terakhir diperbarui: <span class="dyn-tahun"></span></p>
                    
                    <p>Selamat datang di <strong>SiAbDi (Sistem Absensi Digital)</strong>. Kami menghargai privasi Anda dan berkomitmen untuk melindungi data pribadi seluruh warga sekolah (Siswa, Guru, dan Staf).</p>

                    <h4 class="font-bold text-indigo-700 mt-4">1. Informasi yang Kami Kumpulkan</h4>
                    <p>Aplikasi ini mengumpulkan data yang diperlukan semata-mata untuk keperluan administrasi sekolah, meliputi:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Identitas Siswa:</strong> Nama Lengkap, NISN, Kelas, dan Jenis Kelamin.</li>
                        <li><strong>Data Kehadiran:</strong> Waktu (timestamp) saat melakukan scan absensi datang dan pulang.</li>
                        <li><strong>Foto (Opsional):</strong> Pada fitur tertentu, foto mungkin diambil saat proses absensi untuk validasi.</li>
                    </ul>

                    <h4 class="font-bold text-indigo-700 mt-4">2. Penggunaan Data</h4>
                    <p>Data yang dikumpulkan digunakan untuk:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Mencatat kehadiran harian secara otomatis dan real-time.</li>
                        <li>Membuat laporan rekapitulasi kehadiran (Hadir, Sakit, Izin, Alpa) untuk Guru dan Wali Kelas.</li>
                        <li>Memantau kedisiplinan siswa di lingkungan sekolah.</li>
                    </ul>

                    <h4 class="font-bold text-indigo-700 mt-4">3. Penyimpanan Data</h4>
                    <p>Seluruh data disimpan secara aman menggunakan infrastruktur <strong>Google Cloud (Google Sheets & Google Drive)</strong> milik sekolah. Akses terhadap database dibatasi hanya untuk Administrator dan Guru yang berwenang.</p>

                    <h4 class="font-bold text-indigo-700 mt-4">4. Keamanan</h4>
                    <p>Kami menerapkan langkah-langkah keamanan standar untuk melindungi data dari akses yang tidak sah. Namun, harap diingat bahwa tidak ada metode transmisi data melalui internet yang 100% aman.</p>

                    <h4 class="font-bold text-indigo-700 mt-4">5. Kontak</h4>
                    <p>Jika Anda memiliki pertanyaan mengenai kebijakan privasi ini atau ingin mengajukan perbaikan data, silakan hubungi Administrator IT Sekolah atau pengembang aplikasi melalui WhatsApp yang tertera di footer aplikasi.</p>
                </div>

                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-100">
                    <button type="button" onclick="closePrivacyModal()" class="inline-flex w-full justify-center rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-bold text-white shadow-sm hover:bg-indigo-500 sm:ml-3 sm:w-auto transition-all transform active:scale-95">
                        Saya Mengerti
                    </button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- <script src="app.js"></script> -->
  
  <script>

  // ============================================================
// KONFIGURASI API (WAJIB DIISI URL WEB APP GOOGLE APPS SCRIPT)
// ============================================================
const API_URL = "https://script.google.com/a/macros/admin.sma.belajar.id/s/AKfycbwGTj7Jd1DFJ4GmaPGMLRwKG8a-_m23I0ky1kDqJXenYNfqZZg79deYnsMH1wZVLugV/exec"; 

// Fungsi Utama untuk menembak API Google Apps Script
async function fetchAPI(action, params = {}) {
    params.action = action;
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(params),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            redirect: 'follow'
        });
        return await response.json();
    } catch (error) {
        console.error("Fetch Error:", error);
        throw error;
    }
}

// ============================================================
// INIT DATA APLIKASI AWAL (Pengganti tag <?!= ... ?>)
// ============================================================
async function initAppConfigs() {
    try {
        const result = await fetchAPI('getSettings');
        if (result) {
            document.querySelectorAll('.dyn-logo').forEach(el => { if(el.tagName === 'IMG') el.src = result.logo; });
            document.querySelectorAll('.dyn-namasekolah').forEach(el => el.innerHTML = result.namasekolah);
            document.querySelectorAll('.dyn-provinsi').forEach(el => el.innerHTML = result.provinsi);
            document.querySelectorAll('.dyn-website').forEach(el => el.innerHTML = result.website);
            document.querySelectorAll('.dyn-website-link').forEach(el => el.href = (result.website.startsWith('http') ? result.website : 'https://' + result.website));
            document.querySelectorAll('.dyn-runningtext').forEach(el => el.innerHTML = result.runningtext);
            document.querySelectorAll('.dyn-tahun').forEach(el => el.innerHTML = result.tahun);
        }
    } catch (e) {
        console.log("Gagal memuat pengaturan awal", e);
    }
}

// ============================================================
// LOGIC SCROLL TO TOP & MODAL PRIVACY
// ============================================================
const contentArea = document.getElementById('mainContentArea');
const scrollBtn = document.getElementById('btnScrollTop');

if(contentArea && scrollBtn) {
    contentArea.onscroll = function() {
        if (contentArea.scrollTop > 300) { scrollBtn.classList.remove('opacity-0', 'translate-y-10', 'invisible'); } 
        else { scrollBtn.classList.add('opacity-0', 'translate-y-10', 'invisible'); }
    };
}

function scrollToTop() {
    if(contentArea) { contentArea.scrollTo({ top: 0, behavior: "smooth" }); }
}

function showPrivacyModal(e) {
    if(e) e.preventDefault();
    const modal = document.getElementById('privacyModal');
    if(modal) { modal.classList.remove('hidden'); }
}

function closePrivacyModal() {
    const modal = document.getElementById('privacyModal');
    if(modal) { modal.classList.add('hidden'); }
}

// ============================================================
// STATE & CORE LOGIC
// ============================================================
let currentUser = null, html5QrCode = null, isScanning = false, isSidebarOpen = true, appCache = { siswa: null, guru: null }, existingClasses = [], guruChartInstance = null, adminChartInstance = null;

const dateElement = document.getElementById('currentDateDisplay');
if (dateElement) dateElement.textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

const tableState = {
    siswa: { fullData: [], filtered: [], limit: 10, page: 1, search: '', classFilter: '' },
    guru: { fullData: [], filtered: [], limit: 10, page: 1, search: '', classFilter: '' },
    libur: { fullData: [], filtered: [], limit: 10, page: 1, search: '' },
    rekap: { fullData: [], filtered: [], limit: 10, page: 1, search: '' },
    monitoring: { fullData: [], filtered: [], limit: 10, page: 1, search: '', statusFilter: '' }
};

function handleTableSearch(type, query) { tableState[type].search = query.toLowerCase(); tableState[type].page = 1; processTableData(type); }
function handleTableClassFilter(type, value) { if (tableState[type]) { tableState[type].classFilter = value; tableState[type].page = 1; processTableData(type); } }
function handleTableStatusFilter(type, status) { if (tableState[type]) { tableState[type].statusFilter = status; tableState[type].page = 1; processTableData(type); } }
function handleTableLimit(type, limit) { tableState[type].limit = limit === 'all' ? Infinity : parseInt(limit); tableState[type].page = 1; processTableData(type); }
function changePage(type, direction) { const state = tableState[type]; const maxPage = Math.ceil(state.filtered.length / state.limit); const newPage = state.page + direction; if (newPage >= 1 && newPage <= maxPage) { state.page = newPage; processTableData(type); } }

function processTableData(type) {
    const state = tableState[type];
    let result = [...state.fullData];
    if ((type === 'siswa' || type === 'guru') && state.classFilter) result = result.filter(item => item.kelas === state.classFilter);
    if (type === 'monitoring' && state.statusFilter) result = result.filter(item => item.status === state.statusFilter);
    if (state.search) { const query = state.search.toLowerCase(); result = result.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(query))); }
    state.filtered = result;
    const total = state.filtered.length;
    const totalPages = Math.ceil(total / state.limit);
    if (state.page > totalPages && totalPages > 0) state.page = totalPages;
    if (total === 0) state.page = 1;
    const startIdx = (state.page - 1) * state.limit;
    const endIdx = startIdx + state.limit;
    const pagedData = state.filtered.slice(startIdx, endIdx);
    
    if (type === 'siswa') renderSiswaRows(pagedData, startIdx);
    else if (type === 'guru') renderGuruRows(pagedData, startIdx);
    else if (type === 'libur') renderLiburRows(pagedData, startIdx);
    else if (type === 'rekap') renderRekapRows(pagedData);
    else if (type === 'monitoring') renderMonitoringRows(pagedData, startIdx);
    updatePaginationUI(type, startIdx, pagedData.length, total, state.page, totalPages);
}

function updatePaginationUI(type, startIdx, currentCount, total, currentPage, totalPages) {
    const infoEl = document.getElementById(`info-${type}`); const btnPrev = document.getElementById(`btn-prev-${type}`); const btnNext = document.getElementById(`btn-next-${type}`);
    if (total === 0) { infoEl.textContent = 'Tidak ada data ditemukan.'; btnPrev.disabled = true; btnNext.disabled = true; } 
    else { const end = startIdx + currentCount; infoEl.textContent = `Menampilkan ${startIdx + 1} - ${end} dari ${total} data`; btnPrev.disabled = currentPage === 1; btnNext.disabled = currentPage >= totalPages; }
}

function checkSession() {
    const storedSession = localStorage.getItem('absensiAppSession');
    if (storedSession) {
        try {
            const sessionData = JSON.parse(storedSession);
            if (sessionData && sessionData.success) {
                currentUser = sessionData;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboardContainer').classList.remove('hidden');
                if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
                initDashboard();
            }
        } catch (e) { localStorage.removeItem('absensiAppSession'); }
    }
}

function showView(viewId) {
    document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); el.style.display = 'none'; });
    const target = document.getElementById(viewId);
    if (target) { target.classList.add('active'); target.style.display = 'block'; target.classList.add('animate-fade-in'); }
    let title = "Dashboard";
    switch (viewId) {
        case 'view-data-siswa': title = "Direktori Siswa"; break;
        case 'view-data-guru': title = "Manajemen Guru"; break;
        case 'view-kelola-absen': title = "Kelola Hari Libur"; break;
        case 'view-scanner': title = "Scan Absensi"; break;
        case 'view-monitoring': title = "Monitoring Realtime"; break;
        case 'view-rekap-absensi': title = "Laporan Kehadiran"; break;
        case 'view-rekap-siswa': title = "Rekap Absen Siswa"; break; // <--- TAMBAHKAN BARIS INI
        case 'view-kartu-siswa': title = "Kartu Absensi Digital"; break;
        case 'view-pengaturan': title = "Pengaturan Sistem"; break;
    }
    document.getElementById('pageTitle').textContent = title;
    closeSidebarMobile();
}

function setActiveMenu(targetName) {
    const allLinks = document.querySelectorAll('#sidebarMenu a');
    const centerClass = !isSidebarOpen ? 'justify-center px-0' : 'space-x-3 px-4';
    const baseStyle = `flex items-center ${centerClass} py-3 rounded-xl transition-all duration-200 group overflow-hidden whitespace-nowrap cursor-pointer `;
    const activeStyle = "bg-indigo-600 text-white shadow-lg shadow-indigo-900/50";
    const inactiveStyle = "text-gray-400 hover:bg-gray-800 hover:text-white";
    allLinks.forEach(link => { const menuName = link.getAttribute('data-name'); link.className = (menuName === targetName) ? (baseStyle + activeStyle) : (baseStyle + inactiveStyle); });
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    const labels = document.querySelectorAll('.sidebar-label');
    const header = document.getElementById('sidebarHeader');
    const userCard = document.getElementById('userProfileCard');
    const logoutBtn = document.getElementById('btnLogout');
    const menuLinks = document.querySelectorAll('#sidebarMenu a');
    const isMobile = window.innerWidth < 768;

    if (isMobile) {
        if (sidebar.classList.contains('-translate-x-full')) { 
            sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden', 'pointer-events-none'); setTimeout(() => overlay.classList.remove('opacity-0'), 10); 
        } else { 
            sidebar.classList.add('-translate-x-full'); overlay.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => overlay.classList.add('hidden'), 300); 
        }
    } else {
        if (isSidebarOpen) {
            sidebar.classList.remove('w-64'); sidebar.classList.add('w-20');
            document.getElementById('mainContent').classList.remove('md:ml-64'); document.getElementById('mainContent').classList.add('md:ml-20');
            header.classList.remove('px-6', 'justify-start'); header.classList.add('px-0', 'justify-center');
            userCard.classList.remove('space-x-3', 'p-3', 'bg-black/20', 'border'); userCard.classList.add('justify-center', 'p-0', 'bg-transparent', 'border-transparent');
            logoutBtn.classList.remove('space-x-3', 'justify-start', 'px-4'); logoutBtn.classList.add('justify-center', 'px-0');
            menuLinks.forEach(link => { link.classList.remove('space-x-3', 'px-4'); link.classList.add('justify-center', 'px-0'); });
            labels.forEach(el => { el.classList.add('hidden'); });
            isSidebarOpen = false;
        } else {
            sidebar.classList.remove('w-20'); sidebar.classList.add('w-64');
            document.getElementById('mainContent').classList.remove('md:ml-20'); document.getElementById('mainContent').classList.add('md:ml-64');
            header.classList.add('px-6', 'justify-start'); header.classList.remove('px-0', 'justify-center');
            userCard.classList.add('space-x-3', 'p-3', 'bg-black/20', 'border'); userCard.classList.remove('justify-center', 'p-0', 'bg-transparent', 'border-transparent');
            logoutBtn.classList.add('space-x-3', 'justify-start', 'px-4'); logoutBtn.classList.remove('justify-center', 'px-0');
            menuLinks.forEach(link => { link.classList.add('space-x-3', 'px-4'); link.classList.remove('justify-center', 'px-0'); });
            labels.forEach(el => { el.classList.remove('hidden'); });
            isSidebarOpen = true;
        }
    }
}

function closeSidebarMobile() {
    if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        const overlay = document.getElementById('mobileOverlay');
        overlay.classList.add('opacity-0', 'pointer-events-none'); 
        setTimeout(() => overlay.classList.add('hidden'), 300);
    }
}

function switchLoginTab(tab) {
    document.getElementById('loginError').classList.add('hidden');
    const btnSiswa = document.getElementById('btnSiswaTab');
    const btnAdmin = document.getElementById('btnAdminTab');
    const active = "bg-white text-indigo-600 shadow-sm";
    const inactive = "text-gray-500 hover:text-gray-700 hover:bg-gray-200";
    btnSiswa.className = `flex-1 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 ${tab === 'siswa' ? active : inactive}`;
    btnAdmin.className = `flex-1 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 ${tab === 'admin' ? active : inactive}`;
    if (tab === 'admin') { document.getElementById('formAdminLogin').classList.remove('hidden'); document.getElementById('formSiswaLogin').classList.add('hidden'); } 
    else { document.getElementById('formAdminLogin').classList.add('hidden'); document.getElementById('formSiswaLogin').classList.remove('hidden'); }
}

async function handleLogin(event) { 
    event.preventDefault(); 
    showLoading(); 
    try {
        const result = await fetchAPI('login', {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            nisn: document.getElementById('nisn').value
        });
        hideLoading();
        if (result.success) { 
            currentUser = result; 
            localStorage.setItem('absensiAppSession', JSON.stringify(result)); 
            document.getElementById('loginPage').classList.add('hidden'); 
            document.getElementById('dashboardContainer').classList.remove('hidden'); 
            initDashboard(); 
        } else { 
            const errorDiv = document.getElementById('loginError'); 
            document.getElementById('errorText').textContent = result.message; 
            errorDiv.classList.remove('hidden'); 
            setTimeout(() => errorDiv.classList.add('hidden'), 5000); 
        }
    } catch (error) {
        hideLoading();
        alert('Gagal terhubung ke server: ' + error.toString());
    }
}



function togglePassword() { const passwordInput = document.getElementById('password'); const icon = document.getElementById('togglePasswordIcon'); if (passwordInput.type === 'password') { passwordInput.type = 'text'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } else { passwordInput.type = 'password'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } }

function initDashboard() {
    const name = currentUser.nama || currentUser.username;
    document.getElementById('navUserName').textContent = name;
    document.getElementById('navUserRole').textContent = currentUser.role.toUpperCase();
    document.getElementById('navUserInitial').textContent = name.charAt(0).toUpperCase();
    const menuContainer = document.getElementById('sidebarMenu');
    let menuHTML = '';
    const createItem = (label, icon, onclick, isDefaultActive = false) => {
        const hideText = !isSidebarOpen ? 'hidden' : ''; 
        const centerClass = !isSidebarOpen ? 'justify-center px-0' : 'space-x-3 px-4';
        const style = isDefaultActive ? "bg-indigo-600 text-white shadow-lg shadow-indigo-900/50" : "text-gray-400 hover:bg-gray-800 hover:text-white";
        return `<a data-name="${label}" onclick="${onclick}" class="flex items-center ${centerClass} py-3 rounded-xl transition-all duration-200 group overflow-hidden whitespace-nowrap cursor-pointer ${style}"><i class="fas ${icon} w-6 text-center flex-shrink-0 group-hover:scale-110 transition-transform"></i><span class="sidebar-label font-medium transition-opacity duration-300 ${hideText}">${label}</span></a>`;
    };
    if (currentUser.role === 'admin') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadAdminDashboard()', true);
        menuHTML += createItem('Data Siswa', 'fa-user-graduate', 'loadDataSiswa()');
        menuHTML += createItem('Data Guru', 'fa-chalkboard-teacher', 'loadDataGuru()');
        menuHTML += createItem('Laporan', 'fa-clipboard-list', 'loadRekapAbsensi()');
        menuHTML += createItem('Kelola Absen', 'fa-calendar-times', 'loadKelolaAbsen()');
        menuHTML += createItem('Scan Absensi', 'fa-qrcode', 'loadScanAbsensi()');
        menuHTML += createItem('Pengaturan', 'fa-cog', 'loadPengaturan()');
        loadAdminDashboard();
    } else if (currentUser.role === 'guru') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadGuruDashboard()', true);
        menuHTML += createItem('Monitoring', 'fa-eye', 'loadMonitoringAbsensi()');
        menuHTML += createItem('Scan Absensi', 'fa-qrcode', 'loadScanAbsensi()');
        loadGuruDashboard();
    } else if (currentUser.role === 'siswa') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadSiswaDashboard()', true);
        menuHTML += createItem('Profil Saya', 'fa-user', 'showProfilSiswa()');
        menuHTML += createItem('Rekap Absen', 'fa-file-pdf', 'loadRekapSiswa()');
        menuHTML += createItem('Kartu Saya', 'fa-id-card', 'loadQRCodeSiswa()');
        loadSiswaDashboard();
    }
    menuContainer.innerHTML = menuHTML;
    loadKelasSuggestions();
    initMobileNav();
}

function initMobileNav() {
    const role = currentUser.role;
    document.getElementById('mobileHeaderRole').textContent = role;
    
    // Tarik elemen tombol header atas
    const btnLaporan = document.getElementById('btnMobileLaporan');
    const btnSettings = document.getElementById('btnMobileSettings');
    const btnLogout = document.getElementById('btnMobileLogout');
    const schoolInfo = document.getElementById('mobileHeaderSchoolInfo');
    
    let navHTML = '';

    const createBottomNav = (label, icon, onclick, isCenter = false) => {
        if (isCenter) {
            return `
            <div class="relative -top-5 flex flex-col items-center">
                <button onclick="${onclick}" class="flex items-center justify-center w-14 h-14 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-full text-white shadow-lg shadow-indigo-500/40 border-4 border-white transform transition active:scale-95">
                    <i class="fas ${icon} text-2xl"></i>
                </button>
                <span class="absolute -bottom-4 w-full text-center text-[9px] font-bold text-indigo-600 whitespace-nowrap">${label}</span>
            </div>`;
        } else {
            return `
            <button onclick="${onclick}" class="flex flex-col items-center text-gray-400 hover:text-indigo-600 p-2 min-w-[64px] transition-colors">
                <i class="fas ${icon} text-xl mb-1"></i>
                <span class="text-[9px] font-bold leading-none">${label}</span>
            </button>`;
        }
    };

    if (role === 'admin') {
        // Header Admin: Tampil 3 Tombol Kanan, Sembunyikan Text Sekolah
        btnLaporan.classList.remove('hidden'); btnLaporan.classList.add('flex');
        btnSettings.classList.remove('hidden'); btnSettings.classList.add('flex');
        btnLogout.classList.remove('hidden'); btnLogout.classList.add('flex');
        schoolInfo.classList.remove('flex'); schoolInfo.classList.add('hidden');
        
        // Menu Bawah Admin
        navHTML += createBottomNav('Home', 'fa-home', 'loadAdminDashboard()');
        navHTML += createBottomNav('Siswa', 'fa-users', 'loadDataSiswa()');
        navHTML += createBottomNav('Scan', 'fa-qrcode', 'loadScanAbsensi()', true);
        navHTML += createBottomNav('Guru', 'fa-chalkboard-teacher', 'loadDataGuru()');
        navHTML += createBottomNav('Libur', 'fa-calendar-times', 'loadKelolaAbsen()');

    } else if (role === 'guru') {
        // Header Guru: Sembunyikan Semua Tombol Kanan, Tampilkan Text Sekolah
        btnLaporan.classList.remove('flex'); btnLaporan.classList.add('hidden');
        btnSettings.classList.remove('flex'); btnSettings.classList.add('hidden');
        btnLogout.classList.remove('flex'); btnLogout.classList.add('hidden');
        schoolInfo.classList.remove('hidden'); schoolInfo.classList.add('flex');
        
        // Menu Bawah Guru: 5 Item
        navHTML += createBottomNav('Home', 'fa-home', 'loadGuruDashboard()');
        navHTML += createBottomNav('Akun', 'fa-user-circle', 'showProfilGuruMobile()');
        navHTML += createBottomNav('Scan', 'fa-qrcode', 'loadScanAbsensi()', true);
        navHTML += createBottomNav('Monitor', 'fa-desktop', 'loadMonitoringAbsensi()');
        navHTML += createBottomNav('Keluar', 'fa-sign-out-alt', 'logout()');

    } else if (role === 'siswa') {
        // Header Siswa: Sembunyikan Semua Tombol Kanan, Tampilkan Text Sekolah
        btnLaporan.classList.remove('flex'); btnLaporan.classList.add('hidden');
        btnSettings.classList.remove('flex'); btnSettings.classList.add('hidden');
        btnLogout.classList.remove('flex'); btnLogout.classList.add('hidden');
        schoolInfo.classList.remove('hidden'); schoolInfo.classList.add('flex');
        
        // Menu Bawah Siswa: 5 Item (Sempurna dan Seimbang)
        navHTML += createBottomNav('Home', 'fa-home', 'loadSiswaDashboard()');
        navHTML += createBottomNav('Profil', 'fa-user', 'showProfilSiswa()');
        navHTML += createBottomNav('Kartu', 'fa-qrcode', 'loadQRCodeSiswa()', true); // Kartu jadi besar di tengah
        navHTML += createBottomNav('Rekap', 'fa-file-pdf', 'loadRekapSiswa()');
        navHTML += createBottomNav('Keluar', 'fa-sign-out-alt', 'logout()');
    }

    document.getElementById('mobileBottomNav').innerHTML = navHTML;
}

// Fungsi Baru: Popup Profil Khusus Guru di Mobile
function showProfilGuruMobile() {
    // Menarik data "Total Siswa" langsung dari angka yang sudah di-load di dashboard
    const totalSiswa = document.getElementById('statGuruTotal') ? document.getElementById('statGuruTotal').innerText : '0';
    const namaKelas = currentUser.kelas ? currentUser.kelas : 'Semua Kelas';
    const namaGuru = currentUser.nama || currentUser.username || 'Guru';

    const modalContent = `
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-[300px] w-full relative overflow-hidden animate-slide-up mx-auto mt-20 md:mt-0">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-50 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fas fa-times"></i></button>

        <div class="text-center mb-6 mt-2">
            <div class="w-20 h-20 bg-gradient-to-br from-indigo-100 to-purple-200 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white shadow-md text-4xl">
                <i class="fas fa-user-circle"></i>
            </div>
            <h3 class="font-bold text-xl text-gray-800 tracking-tight leading-tight">${namaGuru}</h3>
            <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest mt-1 bg-purple-50 inline-block px-3 py-1 rounded-full border border-purple-100">Akun Guru</p>
        </div>

        <div class="bg-white rounded-2xl p-1 mb-6 border border-gray-100 shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)]">
            <div class="flex justify-between items-center p-3 border-b border-gray-50">
                <div class="flex items-center gap-2"><i class="fas fa-chalkboard text-indigo-400"></i> <span class="text-[11px] font-bold text-gray-500 uppercase">Kelas</span></div>
                <span class="text-sm font-extrabold text-gray-800 bg-gray-50 px-3 py-1 rounded-lg">${namaKelas}</span>
            </div>
            <div class="flex justify-between items-center p-3">
                <div class="flex items-center gap-2"><i class="fas fa-users text-indigo-400"></i> <span class="text-[11px] font-bold text-gray-500 uppercase">Siswa</span></div>
                <span class="text-sm font-extrabold text-gray-800 bg-gray-50 px-3 py-1 rounded-lg">${totalSiswa} Orang</span>
            </div>
        </div>

        <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4 text-center relative overflow-hidden">
            <div class="absolute -right-4 -top-4 text-indigo-100 opacity-50"><i class="fas fa-qrcode text-6xl"></i></div>
            <i class="fas fa-camera text-indigo-500 text-2xl mb-2 relative z-10"></i>
            <p class="text-xs font-medium text-indigo-800 leading-relaxed relative z-10">
                Untuk memulai Absensi, silakan ketuk tombol <b class="text-indigo-600">Scan Kamera</b> berwarna ungu di bawah layar Anda.
            </p>
        </div>
    </div>
    `;
    showModal(modalContent);
}

async function loadKelasSuggestions() { 
    try {
        const result = await fetchAPI('getKelasList');
        if (result.success) existingClasses = result.data; 
    } catch(e) {}
}

function refreshData(type) {
    const btnIcon = event ? event.currentTarget.querySelector('i') : null;
    if(btnIcon) btnIcon.classList.add('fa-spin');
    if (type === 'siswa') { tableState.siswa.fullData = []; loadDataSiswa(); showAlert('success', 'Data siswa diperbarui.'); } 
    else if (type === 'guru') { tableState.guru.fullData = []; loadDataGuru(); showAlert('success', 'Data guru diperbarui.'); }
    else if (type === 'dashboard') {
        if (currentUser.role === 'admin') loadAdminDashboard();
        else if (currentUser.role === 'guru') loadGuruDashboard();
        else loadSiswaDashboard();
        showAlert('success', 'Statistik Dashboard diperbarui.');
    } else if (type === 'monitoring') { tableState.monitoring.fullData = []; loadMonitoringAbsensi(); showAlert('success', 'Data monitoring diperbarui.'); }
    if(btnIcon) setTimeout(() => btnIcon.classList.remove('fa-spin'), 1000);
}

async function loadAdminDashboard() {
    stopAndBack(false); setActiveMenu('Dashboard'); showView('view-admin-dashboard');
    document.getElementById('adminDateDisplay').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    try {
        const result = await fetchAPI('getMonitoringRealtime', { filterKelas: null });
        if (result.success) {
            const data = result.data;
            const total = data.length;
            const hadir = data.filter(d => d.status === 'Hadir').length;
            const sakit = data.filter(d => d.status === 'Sakit').length;
            const izin = data.filter(d => d.status === 'Izin').length;
            const alpa = data.filter(d => d.status === 'Alpa').length;
            const belum = data.filter(d => d.status === 'Belum Absen').length;
            animateValue("admStatTotal", 0, total, 800); animateValue("admStatHadir", 0, hadir, 800); animateValue("admStatSakit", 0, sakit, 800);
            animateValue("admStatIzin", 0, izin, 800); animateValue("admStatAlpa", 0, alpa, 800);
            renderAdminChart(hadir, sakit, izin, alpa, belum);
        }
    } catch(e) {}
}

function renderAdminChart(hadir, sakit, izin, alpa, belum) {
    const ctx = document.getElementById('adminAttendanceChart');
    if (!ctx) return;
    if (adminChartInstance) adminChartInstance.destroy();
    if (typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); }
    adminChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Hadir', 'Sakit', 'Izin', 'Alpa', 'Belum Absen'], datasets: [{ label: 'Jumlah Siswa', data: [hadir, sakit, izin, alpa, belum], backgroundColor: ['#10B981', '#EAB308', '#3B82F6', '#EF4444', '#9CA3AF'], borderRadius: 8, barPercentage: 0.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (val) => val > 0 ? val : '', font: { weight: 'bold' }, color: '#666' } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 2] } }, x: { grid: { display: false } } } } });
}

async function loadGuruDashboard() {
    stopAndBack(false); setActiveMenu('Dashboard'); showView('view-guru-dashboard');
    document.getElementById('guruDashboardDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const myClass = currentUser.role === 'guru' ? currentUser.kelas : null;
    if(myClass) document.querySelector('#view-guru-dashboard h2').textContent = `Dashboard Guru (${myClass})`;
    try {
        const result = await fetchAPI('getMonitoringRealtime', { filterKelas: myClass });
        if (result.success) {
            const data = result.data; 
            const totalSiswa = data.length; const sakit = data.filter(d => d.status === 'Sakit').length; const izin = data.filter(d => d.status === 'Izin').length; const alpa = data.filter(d => d.status === 'Alpa').length; const hadir = data.filter(d => d.status === 'Hadir').length; const belumAbsen = data.filter(d => d.status === 'Belum Absen').length;
            animateValue("statGuruTotal", 0, totalSiswa, 1000); animateValue("statGuruSakit", 0, sakit, 1000); animateValue("statGuruIzin", 0, izin, 1000); animateValue("statGuruAlpa", 0, alpa, 1000);
            renderGuruChart(hadir, sakit, izin, alpa, belumAbsen);
        }
    } catch(e) {}
}

function renderGuruChart(hadir, sakit, izin, alpa, belumAbsen) {
    const ctx = document.getElementById('guruAttendanceChart');
    if (!ctx) return;
    if (guruChartInstance) guruChartInstance.destroy();
    if (typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); }
    guruChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Hadir', 'Sakit', 'Izin', 'Alpa', 'Belum Absen'], datasets: [{ label: 'Jumlah Siswa', data: [hadir, sakit, izin, alpa, belumAbsen], backgroundColor: ['#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#9CA3AF'], borderRadius: 6, barPercentage: 0.6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (value) => value > 0 ? value : '', font: { weight: 'bold', size: 11 }, color: '#4B5563' } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#F3F4F6' }, ticks: { stepSize: 1 } }, x: { grid: { display: false } } } } });
}

function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if(!obj) return;
    let startTimestamp = null;
    const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerHTML = Math.floor(progress * (end - start) + start); if (progress < 1) window.requestAnimationFrame(step); };
    window.requestAnimationFrame(step);
}

async function loadSiswaDashboard() {
    stopAndBack(false); setActiveMenu('Dashboard'); showView('view-siswa-dashboard'); showLoading();
    try {
        if (currentUser) {
            const firstName = currentUser.nama ? currentUser.nama.split(' ')[0] : 'Siswa';
            document.getElementById('dashGreeting').textContent = firstName;
            document.getElementById('profileNameSidebar').textContent = currentUser.nama;
            document.getElementById('profileNisnSidebar').textContent = currentUser.nisn;
            document.getElementById('profileKelasSidebar').textContent = currentUser.kelas;
        }
        document.getElementById('dashDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    } catch (e) {}

    try {
        const result = await fetchAPI('getAbsensiToday', { nisn: currentUser.nisn });
        hideLoading();
        if (result) {
            const absensi = result && result.success ? result.data : null;
            const isLibur = result.isLibur; const infoLibur = result.keteranganLibur;
            const elHero = document.getElementById('heroCard'), elBadge = document.getElementById('dashStatusBadge');
            const elValMasuk = document.getElementById('valMasuk'), elValPulang = document.getElementById('valPulang'), elAlert = document.getElementById('alertBelumAbsen');

            if (isLibur) {
                if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-gradient-to-br from-rose-600 to-red-800 p-6 text-white shadow-xl shadow-rose-200 transition-all duration-500 group";
                if (elBadge) { elBadge.className = "px-4 py-2 rounded-xl bg-white/20 backdrop-blur-md border border-white/20 text-white text-xs font-bold shadow-sm"; elBadge.innerHTML = `<i class="fas fa-calendar-times mr-2"></i> HARI LIBUR`; }
                if (elValMasuk) { elValMasuk.parentElement.innerHTML = `<div class="text-center py-2"><i class="fas fa-mug-hot text-3xl mb-2 opacity-80"></i><p class="text-sm font-bold uppercase tracking-widest">${infoLibur}</p><p class="text-[10px] mt-1 opacity-75">Tidak ada absensi hari ini</p></div>`; if(elValPulang) elValPulang.parentElement.style.display = 'none'; if(elValMasuk) elValMasuk.parentElement.classList.add('col-span-2'); }
                if (elAlert) { elAlert.classList.add('hidden'); elAlert.classList.remove('flex'); }
                return; 
            }

            if (!absensi) {
                if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-slate-800 p-6 text-white shadow-xl shadow-slate-200 transition-all duration-500 group";
                if (elBadge) { elBadge.className = "px-4 py-2 rounded-xl bg-rose-500/20 backdrop-blur-md border border-rose-500/30 text-rose-200 text-xs font-bold shadow-sm animate-pulse"; elBadge.innerHTML = `<i class="fas fa-circle text-[8px] mr-2"></i> BELUM ABSEN`; }
                if (elValMasuk) elValMasuk.textContent = "--:--";
                if (elValPulang) elValPulang.textContent = "--:--";
                if (elAlert) { elAlert.classList.remove('hidden'); elAlert.classList.add('flex'); }
            } else {
                if (elAlert) { elAlert.classList.add('hidden'); elAlert.classList.remove('flex'); }
                if (elValMasuk) elValMasuk.textContent = absensi.jamDatang || "--:--";
                if (!absensi.jamPulang) {
                    if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-gradient-to-br from-emerald-600 to-teal-800 p-6 text-white shadow-xl shadow-emerald-200 transition-all duration-500 group";
                    if (elBadge) { elBadge.className = "px-4 py-2 rounded-xl bg-white/20 backdrop-blur-md border border-white/20 text-white text-xs font-bold shadow-sm"; elBadge.innerHTML = `<i class="fas fa-clock animate-pulse mr-2"></i> SEDANG BERLANGSUNG`; }
                    if (elValPulang) elValPulang.textContent = "--:--";
                } else {
                    if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-gradient-to-br from-indigo-600 to-violet-800 p-6 text-white shadow-xl shadow-indigo-200 transition-all duration-500 group";
                    if (elBadge) { elBadge.className = "px-4 py-2 rounded-xl bg-white/20 backdrop-blur-md border border-white/20 text-white text-xs font-bold shadow-sm"; elBadge.innerHTML = `<i class="fas fa-check-circle mr-2"></i> SELESAI HARI INI`; }
                    if (elValPulang) elValPulang.textContent = absensi.jamPulang;
                }
            }
        }
    } catch(error) {
        hideLoading();
    }
}

async function loadKelolaAbsen() {
    stopAndBack(false); setActiveMenu('Kelola Absen'); showView('view-kelola-absen');
    document.getElementById('tbody-libur').innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data...</td></tr>';
    
    try {
        const result = await fetchAPI('getHariLibur');
        if (result.success) { tableState.libur.fullData = result.data; processTableData('libur'); } 
        else { document.getElementById('tbody-libur').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>'; }
    } catch(e) {}
    loadGlobalConfig();
}

async function loadGlobalConfig() {
    const inputs = document.querySelectorAll('#view-kelola-absen input[type="time"]');
    inputs.forEach(el => el.disabled = true);
    try {
        const res = await fetchAPI('getAppConfig');
        inputs.forEach(el => el.disabled = false);
        if(res.success) {
            const conf = res.data;
            document.getElementById('conf_masuk_mulai').value = conf.jam_masuk_mulai;
            document.getElementById('conf_masuk_akhir').value = conf.jam_masuk_akhir;
            document.getElementById('conf_pulang_mulai').value = conf.jam_pulang_mulai;
            document.getElementById('conf_pulang_akhir').value = conf.jam_pulang_akhir;
        }
    } catch(e) {}
}

async function saveGlobalConfig(e) {
    e.preventDefault();
    const btn = document.getElementById('btnSaveConfig'); const originalText = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menyimpan...';
    const formData = new FormData(e.target);
    const newConfig = { jam_masuk_mulai: formData.get('jam_masuk_mulai'), jam_masuk_akhir: formData.get('jam_masuk_akhir'), jam_pulang_mulai: formData.get('jam_pulang_mulai'), jam_pulang_akhir: formData.get('jam_pulang_akhir') };
    
    try {
        const res = await fetchAPI('saveAppConfig', { newConfig: newConfig });
        btn.disabled = false; btn.innerHTML = originalText;
        if(res.success) showAlert('success', 'Pengaturan waktu berhasil disimpan!'); else showAlert('error', res.message);
    } catch(err) {
        btn.disabled = false; btn.innerHTML = originalText; showAlert('error', 'Gagal koneksi: ' + err);
    }
}

function renderLiburRows(data, startIdx) {
    const tbody = document.getElementById('tbody-libur');
    if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">Tidak ada jadwal libur.</td></tr>'; return; }
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    tbody.innerHTML = data.map((item, i) => `
        <tr class="hover:bg-gray-50 border-b border-gray-50 transition group">
            <td class="p-4 text-center text-gray-500">${startIdx + i + 1}</td>
            <td class="p-4 font-mono font-medium text-indigo-700">${new Date(item.tanggal).toLocaleDateString('id-ID', options)}</td>
            <td class="p-4 font-bold text-gray-700">${item.keterangan}</td>
            <td class="p-4 text-center"><div class="flex justify-center space-x-2 opacity-80 group-hover:opacity-100"><button onclick="editLibur('${item.tanggal}', '${item.keterangan}')" class="p-2 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition"><i class="fas fa-edit"></i></button><button onclick="deleteLiburConfirm('${item.tanggal}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition"><i class="fas fa-trash"></i></button></div></td>
        </tr>`).join('');
}

function editLibur(tgl, ket) { showModal(createLiburModal({ tanggal: tgl, keterangan: ket })); }
function createLiburModal(data) {
    const inputClass = "w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-3 transition-all mb-4";
    return `<div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative overflow-hidden animate-fade-in"><button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><div class="text-center mb-6"><div class="w-14 h-14 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-calendar-day"></i></div><h3 class="font-bold text-xl text-gray-800">Edit Hari Libur</h3><p class="text-xs text-gray-500 mt-1">Perbarui tanggal atau keterangan</p></div><form onsubmit="saveUpdateLibur(event)"><input type="hidden" name="oldDate" value="${data.tanggal}"><label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Tanggal</label><input type="date" name="newDate" value="${data.tanggal}" required class="${inputClass}"><label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Keterangan</label><input type="text" name="newKeterangan" value="${data.keterangan}" required class="${inputClass}"><div class="flex gap-3 mt-4"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Batal</button><button type="submit" id="btnSaveLibur" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">Simpan Perubahan</button></div></form></div>`;
}

async function saveUpdateLibur(e) {
    e.preventDefault(); const btn = document.getElementById('btnSaveLibur'); const originalText = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menyimpan...'; showLoading();
    const fd = new FormData(e.target);
    try {
        const res = await fetchAPI('updateHariLibur', { oldDate: fd.get('oldDate'), newDate: fd.get('newDate'), newKeterangan: fd.get('newKeterangan') });
        hideLoading(); btn.disabled = false; btn.innerHTML = originalText;
        if (res.success) { closeModal(); loadKelolaAbsen(); showAlert('success', res.message); } else showAlert('error', res.message);
    } catch(error) {
        hideLoading(); btn.disabled = false; btn.innerHTML = originalText; showAlert('error', 'Gagal: ' + error);
    }
}

async function handleAddLibur(e) {
    e.preventDefault(); showLoading(); const fd = new FormData(e.target);
    try {
        const res = await fetchAPI('addHariLibur', { tanggal: fd.get('tanggal'), keterangan: fd.get('keterangan') });
        hideLoading(); if (res.success) { e.target.reset(); loadKelolaAbsen(); showAlert('success', 'Jadwal libur ditambahkan'); } else showAlert('error', res.message);
    } catch(err) {}
}

async function deleteLiburConfirm(tgl) {
    if (confirm('Hapus hari libur ini?')) { 
        showLoading(); 
        try {
            await fetchAPI('deleteHariLibur', { tanggal: tgl });
            hideLoading(); loadKelolaAbsen(); showAlert('success', 'Jadwal libur dihapus');
        } catch(e) {}
    }
}

async function loadDataSiswa() {
    stopAndBack(false); setActiveMenu('Data Siswa'); showView('view-data-siswa');
    const dropdown = document.getElementById('filterKelasSiswa');
    if (dropdown && existingClasses && existingClasses.length > 0) {
        const currentValue = dropdown.value; let options = '<option value="">Semua Kelas</option>'; existingClasses.forEach(kelas => { options += `<option value="${kelas}">${kelas}</option>`; });
        dropdown.innerHTML = options; if (currentValue) dropdown.value = currentValue;
    }
    if (tableState.siswa.fullData.length > 0) processTableData('siswa');
    else {
        document.getElementById('tbody-siswa').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data siswa...</td></tr>';
        try {
            const result = await fetchAPI('getSiswaList');
            if (result.success) { tableState.siswa.fullData = result.data; processTableData('siswa'); } else showAlert('error', result.message);
        } catch(e) {}
    }
}

function renderSiswaRows(data, startIdx) {
    const tbody = document.getElementById('tbody-siswa');
    if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Data tidak ditemukan.</td></tr>'; return; }
    tbody.innerHTML = data.map((siswa, i) => `
    <tr class="hover:bg-gray-50 transition border-b border-gray-50 group">
        <td class="p-4 text-center text-gray-500 text-sm">${startIdx + i + 1}</td>
        <td class="p-4"><div class="flex items-center"><div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-3">${siswa.nama.charAt(0)}</div><div><div class="font-bold text-sm text-gray-900">${siswa.nama}</div><div class="text-xs text-gray-500 md:hidden">${siswa.nisn}</div></div></div></td>
        <td class="p-4 hidden md:table-cell text-sm text-gray-600 font-mono">${siswa.nisn}</td>
        <td class="p-4 hidden sm:table-cell"><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-bold">${siswa.kelas}</span></td>
        <td class="p-4 text-center"><div class="flex justify-center space-x-2 opacity-80 group-hover:opacity-100"><button onclick='viewSiswa(${JSON.stringify(siswa)})' class="p-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 transition"><i class="fas fa-eye"></i></button><button onclick='editSiswa(${JSON.stringify(siswa)})' class="p-2 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition"><i class="fas fa-edit"></i></button><button onclick="deleteSiswaConfirm('${siswa.nisn}', '${siswa.nama}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition"><i class="fas fa-trash"></i></button><button onclick="generateQRForSiswa('${siswa.nisn}', '${siswa.nama}', '${siswa.kelas}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition"><i class="fas fa-qrcode"></i></button></div></td>
    </tr>`).join('');
}

async function loadDataGuru() {
    stopAndBack(false); setActiveMenu('Data Guru'); showView('view-data-guru');
    const dropdown = document.getElementById('filterKelasGuru');
    if (dropdown && existingClasses && existingClasses.length > 0) {
        const currentValue = dropdown.value; let options = '<option value="">Semua Kelas</option>'; existingClasses.forEach(kelas => { options += `<option value="${kelas}">${kelas}</option>`; });
        dropdown.innerHTML = options; if (currentValue) dropdown.value = currentValue;
    }
    if (tableState.guru.fullData.length > 0) processTableData('guru');
    else {
        document.getElementById('tbody-guru').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data guru...</td></tr>';
        try {
            const result = await fetchAPI('getGuruList', { token: currentUser.token });
            if (result.success) { tableState.guru.fullData = result.data; processTableData('guru'); } else { document.getElementById('tbody-guru').innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500 font-bold">${result.message}</td></tr>`; showAlert('error', result.message); }
        } catch(error) {
            document.getElementById('tbody-guru').innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500">Error: ${error}</td></tr>`;
        }
    }
}

function renderGuruRows(data, startIdx) {
    const tbody = document.getElementById('tbody-guru');
    if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Data tidak ditemukan.</td></tr>'; return; }
    tbody.innerHTML = data.map((guru, i) => {
        const passId = `pass-${startIdx + i}`;
        const iconId = `icon-${startIdx + i}`;
        return `
        <tr class="hover:bg-gray-50 transition border-b border-gray-50 group">
            <td class="p-4 text-center text-gray-500 text-sm">${startIdx + i + 1}</td>
            <td class="p-4 text-sm font-bold text-gray-800">${guru.username}</td>
            <td class="p-4 text-sm text-gray-600">${guru.kelas ? `<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">${guru.kelas}</span>` : '<span class="text-gray-400 italic text-xs">Semua Akses</span>'}</td>
            <td class="p-4 text-sm font-mono relative flex items-center">
                <span id="${passId}" class="text-gray-400 mr-2">••••••••</span>
                <button onclick="toggleTablePass('${passId}', '${iconId}', '${guru.password}')" class="text-gray-400 hover:text-purple-600 focus:outline-none transition">
                    <i id="${iconId}" class="fas fa-eye text-xs"></i>
                </button>
            </td>
            <td class="p-4 text-center"><div class="flex justify-center space-x-2 opacity-80 group-hover:opacity-100"><button onclick='editGuru(${JSON.stringify(guru)})' class="p-2 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition" title="Edit Akun"><i class="fas fa-edit"></i></button><button onclick="showChangeGuruPassModal('${guru.username}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition" title="Ganti Password"><i class="fas fa-key"></i></button><button onclick="deleteGuruConfirm('${guru.username}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition" title="Hapus Akun"><i class="fas fa-trash"></i></button></div></td>
        </tr>`;
    }).join('');
}

function toggleTablePass(spanId, iconId, realPass) {
    const span = document.getElementById(spanId);
    const icon = document.getElementById(iconId);
    if (span.textContent === '••••••••') {
        span.textContent = realPass;
        span.classList.remove('text-gray-400');
        span.classList.add('text-purple-600', 'font-bold');
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        span.textContent = '••••••••';
        span.classList.add('text-gray-400');
        span.classList.remove('text-purple-600', 'font-bold');
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

async function saveSiswa(e, isEdit) {
    e.preventDefault(); 
    showLoading();
    
    const fd = new FormData(e.target);
    let tgl = fd.get('tanggalLahir');
    
    const siswaData = {
        nama: fd.get('nama'), 
        nisn: "'" + fd.get('nisn'), 
        jenisKelamin: fd.get('jenisKelamin'),
        tanggalLahir: tgl, 
        agama: fd.get('agama'), 
        namaAyah: fd.get('namaAyah'),
        namaIbu: fd.get('namaIbu'), 
        noHp: "'" + fd.get('noHp'), 
        kelas: fd.get('kelas'), 
        alamat: fd.get('alamat')
    };
    
    const token = currentUser ? currentUser.token : null; 
    
    try {
        let res;
        if (isEdit) {
            res = await fetchAPI('updateSiswa', { token: token, oldNisn: fd.get('oldNisn'), siswa: siswaData });
        } else {
            res = await fetchAPI('addSiswa', { token: token, siswa: siswaData });
        }
        hideLoading();
        if (res.success) { 
            closeModal(); 
            tableState.siswa.fullData = []; 
            loadDataSiswa(); 
            showAlert('success', res.message); 
        } else {
            showAlert('error', res.message);
        }
    } catch(err) {
        hideLoading(); 
        showAlert('error', 'Terjadi kesalahan: ' + err); 
    }
}

function deleteSiswaConfirm(nisn, nama) {
    Swal.fire({ 
        title: 'Apakah Anda yakin?', text: `Data siswa "${nama}" akan dihapus.`, icon: 'warning', 
        showCancelButton: true, confirmButtonColor: '#EF4444', cancelButtonColor: '#6B7280', 
        confirmButtonText: 'Ya, Hapus!', cancelButtonText: 'Batal', reverseButtons: true 
    }).then(async (result) => {
        if (result.isConfirmed) { 
            showLoading(); 
            const token = currentUser.token; 
            try {
                const r = await fetchAPI('deleteSiswa', { token: token, nisn: nisn });
                hideLoading(); 
                if (r.success) { 
                    tableState.siswa.fullData = []; loadDataSiswa(); Swal.fire('Terhapus!', 'Data siswa berhasil dihapus.', 'success'); 
                } else {
                    Swal.fire('Gagal!', r.message, 'error'); 
                }
            } catch(err) {
                hideLoading(); Swal.fire('Error', 'Terjadi kesalahan server: ' + err, 'error'); 
            }
        }
    });
}

function viewSiswa(siswa) { showModal(createViewSiswaModal(siswa)); }
function showAddSiswaModal() { showModal(createSiswaModal()); }
function editSiswa(s) { showModal(createSiswaModal(s)); }

function createViewSiswaModal(s) {
    const item = (label, value, icon) => `<div class="bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex items-center gap-2 mb-1"><i class="fas ${icon} text-gray-400 text-xs"></i><span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">${label}</span></div><div class="text-sm font-bold text-gray-800 break-words">${value || '-'}</div></div>`;
    return `<div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-2xl w-full animate-fade-in relative"><div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6 text-white flex justify-between items-start"><div class="flex gap-4 items-center"><div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-2xl font-bold border-2 border-white/30 shadow-inner">${s.nama.charAt(0)}</div><div><h3 class="text-xl font-bold tracking-tight">${s.nama}</h3><p class="opacity-90 text-sm flex items-center gap-2"><i class="far fa-id-card"></i> ${s.nisn} <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold ml-2">${s.kelas}</span></p></div></div><button onclick="closeModal()" class="bg-white/10 hover:bg-white/20 p-2 rounded-lg transition text-white"><i class="fas fa-times"></i></button></div><div class="p-6 max-h-[70vh] overflow-y-auto"><div class="mb-6"><h4 class="text-sm font-bold text-emerald-700 mb-3 flex items-center gap-2"><i class="fas fa-user-circle"></i> Data Pribadi</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${item('Jenis Kelamin', s.jenisKelamin, 'fa-venus-mars')}${item('Tanggal Lahir', s.tanggalLahir, 'fa-birthday-cake')}${item('Agama', s.agama, 'fa-pray')}${item('No. Handphone', s.noHp, 'fa-phone')}</div></div><div class="mb-6"><h4 class="text-sm font-bold text-emerald-700 mb-3 flex items-center gap-2"><i class="fas fa-users"></i> Data Orang Tua</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${item('Nama Ayah', s.namaAyah, 'fa-male')}${item('Nama Ibu', s.namaIbu, 'fa-female')}</div></div><div><h4 class="text-sm font-bold text-emerald-700 mb-3 flex items-center gap-2"><i class="fas fa-map-marker-alt"></i> Alamat Lengkap</h4><div class="bg-gray-50 p-4 rounded-xl border border-gray-100 flex gap-3 items-start"><i class="fas fa-home text-gray-400 mt-1"></i><p class="text-sm text-gray-700 leading-relaxed font-medium">${s.alamat || 'Alamat belum diisi.'}</p></div></div></div>
    <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
    <button onclick="closeModal()" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-300 transition">Tutup</button></div></div>`;
}

function createSiswaModal(s = null) {
    const isEdit = s !== null;
    const inputClass = "w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 transition-all";
    const labelClass = "block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide";
    return `<div class="bg-white rounded-2xl shadow-2xl overflow-hidden"><div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50"><h3 class="text-xl font-bold text-gray-800">${isEdit ? 'Edit Data Siswa' : 'Registrasi Siswa Baru'}</h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button></div><div class="p-6 max-h-[75vh] overflow-y-auto"><form onsubmit="saveSiswa(event, ${isEdit})" class="space-y-5"><div class="grid grid-cols-1 md:grid-cols-2 gap-5"><div class="md:col-span-2"><label class="${labelClass}">Nama Lengkap</label><input type="text" name="nama" value="${s?.nama || ''}" required class="${inputClass}" placeholder="Sesuai Akta Kelahiran"></div><div><label class="${labelClass}">NISN</label><input type="number" name="nisn" value="${s?.nisn || ''}" required ${isEdit ? 'readonly class="' + inputClass + ' opacity-60 cursor-not-allowed"' : `class="${inputClass}"`} placeholder="Nomor Induk"></div><div class="relative group"><label class="${labelClass}">Kelas</label><input type="text" name="kelas" id="inputKelas" value="${s?.kelas || ''}" required class="${inputClass}" placeholder="Ketik atau pilih kelas" autocomplete="off" onfocus="openKelasDropdown()" oninput="filterKelasDropdown(this.value)" onblur="closeKelasDropdown()"><div id="dropdownKelasList" class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-xl max-h-40 overflow-y-auto mt-1 scrollbar-hide"></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-5"><div><label class="${labelClass}">Jenis Kelamin</label><select name="jenisKelamin" class="${inputClass}"><option value="Laki-laki" ${s?.jenisKelamin === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option><option value="Perempuan" ${s?.jenisKelamin === 'Perempuan' ? 'selected' : ''}>Perempuan</option></select></div><div><label class="${labelClass}">Tanggal Lahir</label><input type="date" name="tanggalLahir" value="${s?.tanggalLahir || ''}" required class="${inputClass}"></div><div><label class="${labelClass}">Agama</label><select name="agama" class="${inputClass}"><option value="Islam" ${s?.agama === 'Islam' ? 'selected' : ''}>Islam</option><option value="Kristen" ${s?.agama === 'Kristen' ? 'selected' : ''}>Kristen</option><option value="Katolik" ${s?.agama === 'Katolik' ? 'selected' : ''}>Katolik</option><option value="Hindu" ${s?.agama === 'Hindu' ? 'selected' : ''}>Hindu</option><option value="Buddha" ${s?.agama === 'Buddha' ? 'selected' : ''}>Buddha</option><option value="Lainnya" ${s?.agama === 'Lainnya' ? 'selected' : ''}>Lainnya</option></select></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-5 bg-gray-50 p-4 rounded-xl border border-gray-100"><div><label class="${labelClass}">Nama Ayah</label><input type="text" name="namaAyah" value="${s?.namaAyah || ''}" class="${inputClass}"></div><div><label class="${labelClass}">Nama Ibu</label><input type="text" name="namaIbu" value="${s?.namaIbu || ''}" class="${inputClass}"></div><div><label class="${labelClass}">No. Handphone</label><input type="tel" name="noHp" value="${s?.noHp || ''}" class="${inputClass}"></div></div><div><label class="${labelClass}">Alamat Lengkap</label><textarea name="alamat" rows="2" class="${inputClass}">${s?.alamat || ''}</textarea></div><div class="flex justify-end gap-3 pt-4 border-t border-gray-100"><button type="button" onclick="closeModal()" class="px-6 py-2.5 rounded-xl text-gray-600 font-medium hover:bg-gray-100 transition">Batal</button><button type="submit" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">Simpan Data</button></div>${isEdit ? `<input type="hidden" name="oldNisn" value="${s.nisn}">` : ''}</form></div></div>`;
}

async function saveGuru(e, isEdit) {
    e.preventDefault(); 
    const form = e.target; 
    const btn = form.querySelector('button[type="submit"]'); 
    const originalText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Menyimpan...';
    
    const fd = new FormData(form);
    const username = "'" + fd.get('username');
    const password = "'" + fd.get('password');
    const kelas = fd.get('kelas');
    const token = currentUser ? currentUser.token : null;
    
    try {
        let r;
        if (isEdit) r = await fetchAPI('updateGuru', { token: token, oldUsername: fd.get('oldUsername'), username: username, password: password, kelas: kelas });
        else r = await fetchAPI('addGuru', { token: token, username: username, password: password, kelas: kelas });
        
        btn.disabled = false; btn.innerHTML = originalText; 
        if (r && r.success) { 
            closeModal(); tableState.guru.fullData = []; loadDataGuru(); showAlert('success', isEdit ? 'Data guru berhasil diperbarui' : 'Akun Guru berhasil dibuat'); 
        } else {
            showAlert('error', r ? r.message : 'Terjadi kesalahan'); 
        }
    } catch(error) {
        btn.disabled = false; btn.innerHTML = originalText; showAlert('error', 'Gagal koneksi server: ' + error); 
    }
}

async function deleteGuruConfirm(username) {
    if (confirm(`Hapus akses untuk guru: ${username}?`)) { 
        showLoading(); 
        const token = currentUser ? currentUser.token : null; 
        try {
            const r = await fetchAPI('deleteGuru', { token: token, username: username });
            hideLoading(); 
            if (r.success) { 
                tableState.guru.fullData = []; loadDataGuru(); showAlert('success', 'Akun guru berhasil dihapus'); 
            } else {
                showAlert('error', r.message); 
            }
        } catch(error) {
            hideLoading(); showAlert('error', 'Gagal menghapus: ' + error); 
        }
    }
}

function showAddGuruModal() { showModal(createGuruModal()); }
function editGuru(guruData) { showModal(createGuruModal(guruData)); }

function createGuruModal(guru = null) {
    const isEdit = guru !== null;
    const inputClass = "w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-3 transition-all mb-4";
    let kelasOptions = '<option value="">-- Pilih Kelas (Opsional) --</option>'; 
    if (existingClasses && existingClasses.length > 0) {
        existingClasses.forEach(k => { 
            const selected = (guru && guru.kelas === k) ? 'selected' : ''; 
            kelasOptions += `<option value="${k}" ${selected}>${k}</option>`; 
        });
    }
    
    return `<div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative overflow-hidden"><button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><div class="text-center mb-6"><div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-chalkboard-teacher"></i></div><h3 class="font-bold text-xl text-gray-800">${isEdit ? 'Edit Akun Guru' : 'Tambah Guru'}</h3></div><form onsubmit="saveGuru(event, ${isEdit})"><label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Username</label><input name="username" value="${guru?.username || ''}" placeholder="Username" required class="${inputClass}"><label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Password</label><input name="password" value="${guru?.password || ''}" placeholder="Password" required class="${inputClass}"><label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Wali Kelas Untuk</label><select name="kelas" class="${inputClass}">${kelasOptions}</select><p class="text-[10px] text-gray-400 -mt-3 mb-4">Jika dipilih, guru hanya bisa melihat siswa di kelas ini.</p>${isEdit ? `<input type="hidden" name="oldUsername" value="${guru.username}">` : ''}<div class="flex gap-3 mt-2"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Batal</button><button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95">Simpan</button></div></form></div>`;
}

function loadRekapAbsensi() {
    stopAndBack(false); setActiveMenu('Laporan'); showView('view-rekap-absensi');
    document.getElementById('rekapEmptyState').classList.remove('hidden');
    document.getElementById('rekapContainer').classList.add('hidden');
    document.getElementById('rekapLoading').classList.add('hidden');
    tableState.rekap.fullData = [];
    const selectKelas = document.getElementById('fKelasRekap');
    if (selectKelas) {
        selectKelas.innerHTML = '<option value="">Semua Kelas</option>';
        if (existingClasses && existingClasses.length > 0) existingClasses.forEach(kelas => { const option = document.createElement('option'); option.value = kelas; option.textContent = kelas; selectKelas.appendChild(option); });
    }
}

async function applyFilter() {
    const emptyState = document.getElementById('rekapEmptyState'); const container = document.getElementById('rekapContainer'); const loading = document.getElementById('rekapLoading');
    emptyState.classList.add('hidden'); container.classList.add('hidden'); loading.classList.remove('hidden');
    const filter = { tanggalMulai: document.getElementById('fStart').value, tanggalAkhir: document.getElementById('fEnd').value, kelas: document.getElementById('fKelasRekap').value };
    
    try {
        const result = await fetchAPI('getAbsensiList', { filter: filter });
        loading.classList.add('hidden'); container.classList.remove('hidden');
        if (result.success) { tableState.rekap.fullData = result.data; processTableData('rekap'); } 
        else { tableState.rekap.fullData = []; processTableData('rekap'); }
    } catch(err) {
        loading.classList.add('hidden'); container.classList.remove('hidden');
    }
}

function exportToExcel() {
    const data = tableState.rekap.filtered; 
    if (!data || data.length === 0) { showAlert('error', 'Tidak ada data untuk di-export.'); return; }
    const btn = document.getElementById('btnExportExcel'); const originalText = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Proses...';
    setTimeout(() => {
        try {
            const excelData = data.map((row, index) => ({ "No": index + 1, "Tanggal": new Date(row.tanggal).toLocaleDateString('id-ID'), "NISN": row.nisn, "Nama Siswa": row.nama, "Kelas": row.kelas, "Jam Datang": row.jamDatang, "Jam Pulang": row.jamPulang, "Keterangan": row.keterangan, "Status": row.status }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Absensi");
            XLSX.writeFile(workbook, `Laporan_Absensi_${new Date().toISOString().slice(0,10)}.xlsx`);
            showAlert('success', 'File berhasil diunduh!');
        } catch (error) { showAlert('error', 'Gagal membuat file Excel.'); } finally { btn.disabled = false; btn.innerHTML = originalText; }
    }, 500);
}

async function loadMonitoringAbsensi() {
    stopAndBack(false); setActiveMenu('Monitoring'); showView('view-monitoring');
    document.getElementById('monitoringDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    const myClass = currentUser.role === 'guru' ? currentUser.kelas : null;
    if (tableState.monitoring.fullData.length > 0) processTableData('monitoring');
    else {
        document.getElementById('tbody-monitoring').innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data...</td></tr>';
        try {
            const result = await fetchAPI('getMonitoringRealtime', { filterKelas: myClass });
            if (result.success) { tableState.monitoring.fullData = result.data; processTableData('monitoring'); } 
            else { document.getElementById('tbody-monitoring').innerHTML = '<tr><td colspan="7" class="p-12 text-center text-gray-400 italic bg-white">Data tidak ditemukan.</td></tr>'; }
        } catch(e) {}
    }
}

function renderRekapRows(data) {
    const tbody = document.getElementById('tbody-rekap');
    if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-gray-400">Tidak ada data ditemukan.</td></tr>'; return; }
    const getStatusColor = (status) => { if(status === 'Hadir') return 'bg-green-100 text-green-700'; if(status === 'Izin') return 'bg-blue-100 text-blue-700'; if(status === 'Sakit') return 'bg-yellow-100 text-yellow-700'; if(status === 'Alpa') return 'bg-red-100 text-red-700'; return 'bg-gray-100 text-gray-600'; };
    tbody.innerHTML = data.map((d, i) => {
        let ketText = d.keterangan || "-", ketStyle = "text-gray-500", ketIcon = "";
        if (String(ketText).includes("Terlambat")) { ketStyle = "text-rose-600 font-bold bg-rose-50 px-2 py-1 rounded border border-rose-100 text-[10px]"; ketIcon = '<i class="fas fa-history mr-1"></i>'; } 
        else if (String(ketText).includes("Pulang Cepat")) { ketStyle = "text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded border border-orange-100 text-[10px]"; ketIcon = '<i class="fas fa-running mr-1"></i>'; } 
        else if (ketText === "Tepat Waktu") { ketStyle = "text-emerald-600 font-bold text-[10px]"; ketIcon = '<i class="fas fa-check-double mr-1"></i>'; }
        return `<tr class="hover:bg-gray-50 border-b border-gray-50 transition"><td class="p-4 text-center text-gray-500 text-xs">${i + 1}</td><td class="p-4 text-sm text-gray-600">${new Date(d.tanggal).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'})}</td><td class="p-4 text-sm font-bold text-gray-900">${d.nama}</td><td class="p-4 text-center text-sm text-gray-600"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">${d.kelas}</span></td><td class="p-4 text-center text-sm font-mono text-gray-600">${d.jamDatang}</td><td class="p-4 text-center text-sm font-mono text-gray-600">${d.jamPulang}</td><td class="p-4 text-center align-middle"><span class="${ketStyle} inline-block whitespace-nowrap">${ketIcon}${ketText}</span></td><td class="p-4 text-center text-sm"><span class="${getStatusColor(d.status)} px-2 py-1 rounded text-xs font-bold">${d.status || 'Hadir'}</span></td></tr>`;
    }).join('');
}

function renderMonitoringRows(data, startIdx) {
    const tbody = document.getElementById('tbody-monitoring');
    if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-12 text-center text-gray-400 italic bg-white">Tidak ada data ditemukan.</td></tr>'; return; }
    const canEdit = (currentUser.role === 'guru' || currentUser.role === 'admin');
    const cursorClass = canEdit ? 'cursor-pointer' : 'cursor-not-allowed opacity-70';
    const disabledAttr = canEdit ? '' : 'disabled';
    tbody.innerHTML = data.map((d, i) => {
        let statusColor = 'bg-gray-100 text-gray-600';
        if(d.status === 'Hadir') statusColor = 'bg-green-100 text-green-700'; else if(d.status === 'Izin') statusColor = 'bg-blue-100 text-blue-700'; else if(d.status === 'Sakit') statusColor = 'bg-yellow-100 text-yellow-700'; else if(d.status === 'Alpa') statusColor = 'bg-red-100 text-red-700';
        let ketText = d.keterangan || "-", ketStyle = "text-gray-400 font-mono text-[10px]", ketIcon = "";
        if (String(ketText).includes("Terlambat")) { ketStyle = "text-rose-600 font-bold bg-rose-50 px-2 py-1 rounded border border-rose-100 text-[10px]"; ketIcon = '<i class="fas fa-history mr-1"></i>'; } else if (String(ketText).includes("Pulang Cepat")) { ketStyle = "text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded border border-orange-100 text-[10px]"; ketIcon = '<i class="fas fa-running mr-1"></i>'; } else if (ketText === "Tepat Waktu") { ketStyle = "text-emerald-600 font-bold text-[10px]"; ketIcon = '<i class="fas fa-check-double mr-1"></i>'; }
        return `<tr class="hover:bg-gray-50 border-b border-gray-50 transition group"><td class="p-4 text-center text-gray-400 text-xs">${startIdx + i + 1}</td><td class="p-4"><div class="font-bold text-sm text-gray-900">${d.nama}</div><div class="text-xs text-gray-500 font-mono">${d.nisn}</div></td><td class="p-4 text-center"><span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded text-xs font-bold border border-indigo-100">${d.kelas}</span></td><td class="p-4 text-center text-xs font-mono text-gray-600">${d.jamDatang}</td><td class="p-4 text-center text-xs font-mono text-gray-600">${d.jamPulang}</td><td class="p-4 text-center align-middle"><span class="${ketStyle} inline-block whitespace-nowrap">${ketIcon}${ketText}</span></td><td class="p-4 text-center relative"><select onchange="changeStatus('${d.nisn}', '${d.nama}', '${d.kelas}', this)" class="text-xs font-bold py-1.5 px-2 rounded-lg border-0 focus:ring-2 focus:ring-indigo-500 shadow-sm appearance-none text-center w-32 ${statusColor} ${cursorClass}" ${disabledAttr}><option value="Belum Absen" ${d.status === 'Belum Absen' ? 'selected' : ''}>Belum Absen</option><option value="Hadir" ${d.status === 'Hadir' ? 'selected' : ''}>Hadir</option><option value="Izin" ${d.status === 'Izin' ? 'selected' : ''}>Izin</option><option value="Sakit" ${d.status === 'Sakit' ? 'selected' : ''}>Sakit</option><option value="Alpa" ${d.status === 'Alpa' ? 'selected' : ''}>Alpa</option></select>${canEdit ? '<i class="fas fa-chevron-down absolute right-6 top-1/2 transform -translate-y-1/2 text-[10px] pointer-events-none opacity-40"></i>' : ''}</td></tr>`;
    }).join('');
}

async function changeStatus(nisn, nama, kelas, selectElement) {
    const newStatus = selectElement.value; selectElement.disabled = true; selectElement.style.opacity = '0.5';
    const token = currentUser ? currentUser.token : null;
    try {
        const res = await fetchAPI('updateAbsensiStatus', { token: token, nisn: nisn, nama: nama, kelas: kelas, newStatus: newStatus });
        selectElement.disabled = false; selectElement.style.opacity = '1';
        if (res.success) {
            let newColor = 'bg-gray-100 text-gray-600'; if(newStatus === 'Hadir') newColor = 'bg-green-100 text-green-700'; else if(newStatus === 'Izin') newColor = 'bg-blue-100 text-blue-700'; else if(newStatus === 'Sakit') newColor = 'bg-yellow-100 text-yellow-700'; else if(newStatus === 'Alpa') newColor = 'bg-red-100 text-red-700';
            selectElement.className = `text-xs font-bold py-1.5 px-2 rounded-lg border-0 focus:ring-2 focus:ring-indigo-500 shadow-sm appearance-none text-center w-32 cursor-pointer ${newColor}`;
        } else { showAlert('error', 'Gagal update: ' + res.message); loadMonitoringAbsensi(); }
    } catch(error) {
        selectElement.disabled = false; selectElement.style.opacity = '1'; showAlert('error', 'Error koneksi: ' + error); 
    }
}

function showMatrixModal() {
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const curMonth = new Date().getMonth();
    const curYear = new Date().getFullYear();
    let monthOpts = '';
    monthNames.forEach((m, i) => { monthOpts += `<option value="${i+1}" ${i === curMonth ? 'selected' : ''}>${m}</option>`; });
    let classOpts = '<option value="">Semua Kelas</option>';
    let isLocked = false;
    if(currentUser.role === 'guru' && currentUser.kelas) {
        classOpts = `<option value="${currentUser.kelas}" selected>${currentUser.kelas}</option>`;
        isLocked = true;
    } else {
        if(existingClasses) existingClasses.forEach(c => classOpts += `<option value="${c}">${c}</option>`);
    }

    const content = `
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full animate-fade-in relative">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-th text-purple-600"></i> Laporan Jurnal Bulanan</h3>
        <div class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bulan</label><select id="mat_bulan" class="w-full border-gray-300 rounded-lg text-sm p-2 bg-gray-50">${monthOpts}</select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tahun</label><input type="number" id="mat_tahun" value="${curYear}" class="w-full border-gray-300 rounded-lg text-sm p-2 bg-gray-50"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kelas</label><select id="mat_kelas" class="w-full border-gray-300 rounded-lg text-sm p-2 bg-gray-50 ${isLocked ? 'cursor-not-allowed opacity-70' : ''}" ${isLocked ? 'disabled' : ''}>${classOpts}</select></div></div><button onclick="processMatrixExport(event)" class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-lg transition"><i class="fas fa-file-excel mr-2"></i> Download Excel</button></div>`;
    showModal(content);
}

async function processMatrixExport(event) {
    const bulan = document.getElementById('mat_bulan').value;
    const tahun = document.getElementById('mat_tahun').value;
    let kelas = document.getElementById('mat_kelas').value;
    if(currentUser.role === 'guru' && currentUser.kelas) kelas = currentUser.kelas; 

    const btn = event.currentTarget;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengambil Data...';
    btn.disabled = true;

    try {
        const res = await fetchAPI('getRekapMatrix', { bulan: bulan, tahun: tahun, filterKelas: kelas });
        closeModal();
        if(!res.success) { showAlert('error', res.message); return; }
        
        const data = res.data; 
        const days = res.days;
        
        let headers = ["No", "NISN", "Nama Siswa", "Kelas"]; 
        for(let i=1; i<=days; i++) headers.push(String(i)); 
        headers.push("H", "S", "I", "A");
        
        let excelRows = [headers];
        
        data.forEach((row, idx) => { 
            let r = [idx+1, row.nisn, row.nama, row.kelas]; 
            row.kehadiran.forEach(s => r.push(s)); 
            r.push(row.stats.H, row.stats.S, row.stats.I, row.stats.A); 
            excelRows.push(r); 
        });
        
        const ws = XLSX.utils.aoa_to_sheet(excelRows);
        const wscols = [{wch:5}, {wch:15}, {wch:30}, {wch:10}]; 
        for(let i=0; i<days; i++) wscols.push({wch:3}); 
        ws['!cols'] = wscols;
        
        const wb = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, `Absensi ${bulan}-${tahun}`); 
        XLSX.writeFile(wb, `Jurnal_Absensi_${kelas||'Semua'}_${bulan}-${tahun}.xlsx`);
        
        showAlert('success', 'Laporan Matriks Berhasil Diunduh!');
        
        btn.innerHTML = '<i class="fas fa-file-excel"></i> Download Excel';
        btn.disabled = false;
    } catch(err) {
        closeModal(); 
        showAlert('error', err); 
        btn.innerHTML = '<i class="fas fa-file-excel"></i> Download Excel';
        btn.disabled = false;
    }
}

async function loadQRCodeSiswa(nisnParam, namaParam, kelasParam) {
    stopAndBack(false); 
    if(currentUser && currentUser.role === 'siswa') setActiveMenu('Kartu Saya');
    showView('view-kartu-siswa'); 
    
    const container = document.getElementById('kartuSiswaContainer');
    container.innerHTML = '<div class="p-10 text-center"><i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i><p class="mt-2 text-sm text-gray-500">Memproses Data Kartu...</p></div>'; 

    const nama = namaParam || currentUser.nama || "Siswa"; 
    const nisn = nisnParam || currentUser.nisn || "1234567890"; 
    const kelas = kelasParam || currentUser.kelas || "X";
    const backFn = (currentUser.role === 'admin' || currentUser.role === 'guru') ? "loadDataSiswa()" : "loadSiswaDashboard()";

    try {
        const dataServer = await fetchAPI('getCardDataServer');
        const logoBase64 = dataServer.logo;
        const namaSekolah = dataServer.sekolah;

        container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-5">
            <div id="idCardElement" style="width: 320px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; position: relative; font-family: sans-serif;">
                
                <div style="background: #312e81; padding: 25px 20px; text-align: center; color: white;">
                    <img src="${logoBase64}" style="height: 70px; width: auto; max-width: 100%; margin: 0 auto 10px auto; object-fit: contain; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
                    
                    <div style="font-weight: 800; font-size: 16px; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px; line-height: 1.2;">${namaSekolah}</div>
                    
                    <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; font-weight: 600;">KARTU ABSENSI DIGITAL</div>
                </div>

                <div style="padding: 25px 20px; text-align: center; background: white;">
                    <div style="width: 150px; height: 150px; margin: 0 auto 15px auto; padding: 8px; background: white; border: 1px solid #f3f4f6; border-radius: 10px; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.05);">
                        <img id="qrImageTarget" src="" style="width: 100%; height: 100%; display: block; border-radius: 4px;" alt="Memuat QR...">
                    </div>
                    
                    <div style="font-size: 20px; font-weight: 800; color: #1f2937; margin-bottom: 4px; line-height: 1.2;">${nama}</div>
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 12px; font-family: monospace;">${nisn}</div>
                    
                    <span style="background: #eef2ff; color: #4f46e5; padding: 6px 16px; border-radius: 99px; font-size: 12px; font-weight: 800; text-transform: uppercase; border: 1px solid #e0e7ff;">${kelas}</span>
                    
                    <div style="margin-top: 20px; border-top: 2px dashed #f3f4f6; padding-top: 15px; font-size: 10px; color: #9ca3af; display: flex; justify-content: space-between;">
                        <span>ID: ${nisn}</span>
                        <span class="dyn-tahun">VALID: ...</span>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex gap-3 w-[320px]">
                <button onclick="window.print()" class="flex-1 bg-slate-800 text-white py-2.5 rounded-lg shadow-md font-bold text-sm hover:bg-slate-900 transition flex items-center justify-center gap-2">
                    <i class="fas fa-print"></i> Cetak
                </button>
                <button onclick="downloadCardAsPNG('${nama}')" class="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg shadow-md font-bold text-sm hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> Unduh
                </button>
            </div>
            <div class="mt-3 w-[320px]">
                <button onclick="${backFn}" class="w-full bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg shadow-sm font-bold text-sm hover:bg-gray-50 transition">
                    Tutup / Kembali
                </button>
            </div>
        </div>`;

        setTimeout(() => {
            const tempDiv = document.createElement("div");
            new QRCode(tempDiv, { text: String(nisn), width: 250, height: 250, correctLevel : QRCode.CorrectLevel.H });
            setTimeout(() => {
                const canvas = tempDiv.querySelector("canvas");
                const imgInTemp = tempDiv.querySelector("img");
                const targetImg = document.getElementById("qrImageTarget");
                if (targetImg) {
                    if (canvas) { targetImg.src = canvas.toDataURL("image/png"); } 
                    else if (imgInTemp) { targetImg.src = imgInTemp.src; }
                }
            }, 100);
        }, 50);

        initAppConfigs();

    } catch(e) {}
}

function downloadCardAsPNG(filename) {
    const element = document.getElementById('idCardElement');
    const btn = event.currentTarget;
    const oldTxt = btn.innerHTML;
    btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Proses..."; 
    btn.disabled = true;

    html2canvas(element, { scale: 2, useCORS: true, allowTaint: false, backgroundColor: "#ffffff", logging: false }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Kartu_${filename}.png`;
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        btn.innerHTML = oldTxt; btn.disabled = false;
    }).catch(err => {
        alert("Gagal Unduh: " + err);
        btn.innerHTML = oldTxt; btn.disabled = false;
    });
}

async function loadPengaturan() {
    stopAndBack(false); setActiveMenu('Pengaturan'); showView('view-pengaturan');
    const form = document.querySelector('#view-pengaturan form');
    const token = currentUser ? currentUser.token : null;
    try {
        const res = await fetchAPI('getLinkSettings', { token: token });
        if(res.success) {
            form.elements['namasekolah'].value = res.data.namasekolah;
            form.elements['provinsi'].value = res.data.provinsi;
            form.elements['tahun'].value = res.data.tahun;
            form.elements['website'].value = res.data.website;
            form.elements['runningtext'].value = res.data.runningtext;
            
            // [BARU] Tampilkan gambar logo ke preview
            document.getElementById('finalLogoData').value = res.data.logo;
            document.getElementById('previewLogoSetting').src = res.data.logo || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBg-h7yQ6aBqgL71tbuETsepWQpv0heHLgIeyhEQGz60PhLI1zk59riPeJoqxGoYzdB-bX4NQOI7ljmDPEOZkBgR14mgvw3p0gJv0q4VLiM26WfwRpAlrMVhLujlWqfUBPsaK84nYbJ6Sdi4oXwBEV5AzaBHvsgfFATXVBeV6M9zJTzd3LQzHylWrDTs5o/s425/logo%20siabdi%20ok.png';
        }
    } catch(e) {}
}

async function saveLinkData(e) {
    e.preventDefault(); const fd = new FormData(e.target); const token = currentUser ? currentUser.token : null;
    const data = { 
        namasekolah: fd.get('namasekolah'), 
        provinsi: fd.get('provinsi'), 
        tahun: fd.get('tahun'), 
        logo: document.getElementById('finalLogoData').value, // [BARU] Ambil dari input hidden
        website: fd.get('website'), 
        runningtext: fd.get('runningtext') 
    };
    showLoading();
    try {
        const res = await fetchAPI('updateLinkSettings', { token: token, data: data });
        hideLoading(); 
        if(res.success) {
            showAlert('success', res.message);
            initAppConfigs(); // Reload tampilan langsung
        } else { showAlert('error', res.message); }
    } catch(err) { hideLoading(); }
}

async function changeAdminPass(e) {
    e.preventDefault(); const fd = new FormData(e.target); const token = currentUser ? currentUser.token : null;
    if(fd.get('newPass').length < 6) { showAlert('error', 'Password minimal 6 karakter'); return; }
    showLoading();
    try {
        const res = await fetchAPI('changeAdminPassword', { token: token, username: currentUser.username, oldPass: fd.get('oldPass'), newPass: fd.get('newPass') });
        hideLoading(); 
        if(res.success) { e.target.reset(); showAlert('success', res.message); } 
        else showAlert('error', res.message);
    } catch(err) { hideLoading(); }
}

function showChangeGuruPassModal(username) {
    showModal(`<div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative overflow-hidden"><button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><div class="text-center mb-6"><div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-key"></i></div><h3 class="font-bold text-xl text-gray-800">Reset Password</h3><p class="text-xs text-gray-500 mt-1">Guru: <b>${username}</b></p></div><form onsubmit="saveGuruPass(event, '${username}')"><label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Password Baru</label><input type="text" name="newPass" required placeholder="Minimal 6 karakter" class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 transition-all mb-4"><div class="flex gap-3 mt-4"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Batal</button><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">Simpan</button></div></form></div>`);
}

async function saveGuruPass(e, username) {
    e.preventDefault(); const fd = new FormData(e.target); const newPass = fd.get('newPass'); const token = currentUser ? currentUser.token : null;
    if(newPass.length < 6) { showAlert('error', 'Password terlalu pendek'); return; }
    showLoading();
    try {
        const res = await fetchAPI('resetGuruPassword', { token: token, username: username, newPass: newPass });
        hideLoading(); 
        if(res.success) { closeModal(); showAlert('success', res.message); } 
        else showAlert('error', res.message);
    } catch(err) { hideLoading(); }
}

function loadScanAbsensi() { isScanning = false; setActiveMenu('Scan Absensi'); showView('view-scanner'); setTimeout(() => { startCamera('environment'); }, 500); }
function startCamera(mode) { if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); initCamera(mode); }).catch(err => initCamera(mode)); } else { initCamera(mode); } }
function initCamera(mode) {
    const loading = document.getElementById('camLoading'); loading.classList.remove('hidden');
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: mode }, { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, (decodedText) => onScanSuccess(decodedText), (errorMessage) => {}).then(() => { loading.classList.add('hidden'); isScanning = false; }).catch((err) => { loading.classList.add('hidden'); const resDiv = document.getElementById('scanResult'); resDiv.classList.remove('hidden'); resDiv.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-xl border border-red-100 font-bold text-sm">Gagal Mengakses Kamera: ${err}</div>`; });
}

async function onScanSuccess(decodedText) {
    if (!decodedText || decodedText.trim() === "" || decodedText === "undefined") return;
    if (isScanning) return; 
    isScanning = true;

    playScanSound(); 

    const resultDiv = document.getElementById('scanResult');
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = `<div class="bg-indigo-50 text-indigo-700 p-4 rounded-xl border border-indigo-100 flex items-center justify-center animate-pulse font-bold shadow-sm"><i class="fas fa-circle-notch fa-spin mr-3"></i> Memproses Data...</div>`;
    
    const myRole = currentUser ? currentUser.role : '';
    const myKelas = currentUser ? currentUser.kelas : '';
    
    try {
        const result = await fetchAPI('scanAbsensi', {
            nisn: decodedText,
            role: myRole,
            kelasGuru: myKelas
        });

        if (result.success) {
            const color = result.type === 'datang' ? 'green' : 'blue';
            resultDiv.innerHTML = `<div class="bg-${color}-50 text-${color}-900 p-6 rounded-2xl border border-${color}-100 shadow-md animate-fade-in relative overflow-hidden"><div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-check-circle text-6xl"></i></div><h3 class="font-bold text-xl uppercase mb-1 tracking-tight">${result.nama || "Siswa"}</h3><p class="text-sm font-semibold opacity-70 mb-4">${result.kelas || ""}</p><div class="bg-white/60 backdrop-blur-sm p-3 rounded-xl border border-${color}-200 inline-block"><div class="text-xs uppercase tracking-widest font-bold opacity-60 mb-1">${result.message}</div><div class="text-3xl font-mono font-bold">${result.type === 'datang' ? result.jamDatang : result.jamPulang}</div></div><p class="text-xs mt-4 font-bold uppercase tracking-wide opacity-50 animate-pulse">Siap untuk siswa berikutnya...</p></div>`;
            setTimeout(() => { isScanning = false; }, 3000);
        } else {
            resultDiv.innerHTML = `<div class="bg-red-50 text-red-700 p-5 rounded-2xl border border-red-100 shadow-sm flex items-center space-x-4"><div class="bg-red-100 p-3 rounded-full"><i class="fas fa-times text-xl"></i></div><div class="text-left"><h4 class="font-bold">Gagal!</h4><p class="text-sm opacity-90">${result.message}</p></div></div>`;
            setTimeout(() => { isScanning = false; }, 4000);
        }
    } catch(err) {
        resultDiv.innerHTML = `<div class="bg-red-50 text-red-700 p-5 rounded-2xl border border-red-100 shadow-sm flex items-center space-x-4"><div class="bg-red-100 p-3 rounded-full"><i class="fas fa-times text-xl"></i></div><div class="text-left"><h4 class="font-bold">Error Koneksi!</h4><p class="text-sm opacity-90">Gagal terhubung ke server.</p></div></div>`;
        setTimeout(() => { isScanning = false; }, 4000);
    }
}

function playScanSound() {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        if (ctx.state === 'suspended') { ctx.resume(); }

        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        oscillator.type = "square"; 
        oscillator.frequency.value = 1200; 
        gainNode.gain.value = 0.15; 

        oscillator.start();
        setTimeout(() => { oscillator.stop(); ctx.close(); }, 150); 
    } catch (e) { console.error("Audio error: " + e); }
}

function stopAndBack(redirect = true) {
    if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; isScanning = false; if (redirect && currentUser) returnToDashboard(); }).catch(() => { html5QrCode = null; if (redirect && currentUser) returnToDashboard(); }); } 
    else if (redirect && currentUser) returnToDashboard();
}

function returnToDashboard() {
    if(currentUser.role === 'admin') loadAdminDashboard(); else if(currentUser.role === 'guru') loadGuruDashboard(); else loadSiswaDashboard();
}

// VARIABEL GLOBAL UNTUK TIMER LOADING
let loadingInterval;

function showLoading() { 
    const overlay = document.getElementById('loadingOverlay');
    const countdownEl = document.getElementById('loadingCountdown');
    const textEl = document.getElementById('loadingText');
    
    // Tampilkan overlay
    overlay.classList.remove('hidden'); 
    
    // Setel ulang teks dan waktu awal
    let timeLeft = 8;
    countdownEl.textContent = timeLeft;
    countdownEl.parentElement.style.display = 'flex'; // Tampilkan lingkaran angka
    textEl.innerHTML = 'Memproses... <br><span class="text-[10px] text-gray-500 font-normal">Mohon tunggu</span>';

    // Bersihkan interval yang mungkin masih berjalan sebelumnya
    clearInterval(loadingInterval);
    
    // Mulai hitung mundur
    loadingInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
            countdownEl.textContent = timeLeft;
        } else if (timeLeft === 0) {
            // Ketika waktu habis, sembunyikan angka dan ubah teks peringatan
            countdownEl.parentElement.style.display = 'none';
            textEl.innerHTML = 'Sedang memproses data... <br><span class="text-[10px] text-orange-600 font-bold">Tunggu sebentar..</span>';
        }
    }, 1000); // Turun setiap 1 detik (1000 ms)
}

function hideLoading() { 
    // Sembunyikan layar dan hentikan waktu berjalan agar tidak jalan diam-diam di background
    document.getElementById('loadingOverlay').classList.add('hidden'); 
    clearInterval(loadingInterval);
}

function logout() { 
    // Tampilkan Popup Konfirmasi SweetAlert2 sebelum memproses keluar
    Swal.fire({
        title: 'Konfirmasi Keluar',
        text: "Apakah Anda yakin ingin keluar dari aplikasi?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6B7280',
        confirmButtonText: 'Ya, Keluar!',
        cancelButtonText: 'Batal',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            executeLogout();
        }
    });
}

// Fungsi eksekusi logout (Dijalankan jika user klik "Ya, Keluar!")
function executeLogout() {
    stopAndBack(false); 
    localStorage.removeItem('absensiAppSession'); 
    currentUser = null; 
    appCache = { siswa: null, guru: null }; 
    document.getElementById('dashboardContainer').classList.add('hidden'); 
    document.getElementById('loginPage').classList.remove('hidden'); 
    
    // Kosongkan form login
    if(document.getElementById('username')) document.getElementById('username').value = ''; 
    if(document.getElementById('password')) document.getElementById('password').value = ''; 
    if(document.getElementById('nisn')) document.getElementById('nisn').value = ''; 
    
    document.getElementById('sidebar').classList.add('-translate-x-full');
}



function showModal(content) { const container = document.getElementById('modalContainer'); container.innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div><div class="relative w-full max-w-2xl transform transition-all animate-fade-in">${content}</div></div>`; }
function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }
function showAlert(type, message) {
    const bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
    const div = document.createElement('div');
    div.className = `fixed top-6 right-6 ${bg} text-white px-6 py-4 rounded-xl shadow-2xl z-[80] flex items-center font-medium animate-fade-in transform translate-y-2`;
    div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-3 text-xl"></i> ${message}`;
    document.body.appendChild(div); setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 300); }, 3000);
}

function showImportSiswaModal() { showModal(createImportModal('Siswa')); }
function showImportGuruModal() { showModal(createImportModal('Guru')); }

function createImportModal(type) {
    return `<div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative overflow-hidden animate-fade-in"><button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><div class="text-center mb-6"><div class="w-14 h-14 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-file-excel"></i></div><h3 class="font-bold text-xl text-gray-800">Import Data ${type}</h3><p class="text-xs text-gray-500 mt-1">Upload file Excel (.xlsx)</p></div><div class="mb-4 text-center"><button onclick="downloadTemplate('${type}')" class="text-xs text-indigo-600 hover:text-indigo-800 underline font-bold mb-3 block"><i class="fas fa-download mr-1"></i> Download Template ${type}</button><p class="text-xs text-gray-500 mb-2">Pastikan format kolom sesuai template.</p></div><input type="file" id="importFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-4"/><button onclick="processImport('${type}')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg transition">Upload & Proses</button></div>`;
}

function downloadTemplate(type) {
    let headers = [], fileName = "";
    if(type === 'Siswa') { headers = [["nama", "nisn", "jenisKelamin", "tanggalLahir", "agama", "namaAyah", "namaIbu", "noHp", "kelas", "alamat"]]; fileName = "Template_Import_Siswa.xlsx"; } 
    else { headers = [["username", "password", "kelas"]]; fileName = "Template_Import_Guru.xlsx"; }
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(headers); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, fileName);
}

function processImport(type) {
    const fileInput = document.getElementById('importFile');
    if(!fileInput.files.length) { showAlert('error', 'Pilih file terlebih dahulu'); return; }
    showLoading(); const file = fileInput.files[0]; const reader = new FileReader();
    reader.onload = async function(e) {
        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        try {
            let res;
            if(type === 'Siswa') {
                res = await fetchAPI('importSiswaBulk', { arr: jsonData });
                hideLoading(); closeModal(); if(res.success) { tableState.siswa.fullData = []; loadDataSiswa(); showAlert('success', res.message); } else showAlert('error', res.message);
            } else {
                res = await fetchAPI('importGuruBulk', { arr: jsonData });
                hideLoading(); closeModal(); if(res.success) { tableState.guru.fullData = []; loadDataGuru(); showAlert('success', res.message); } else showAlert('error', res.message);
            }
        } catch(err) { hideLoading(); showAlert('error', err); }
    };
    reader.readAsArrayBuffer(file);
}

function generateQRForSiswa(nisn, nama, kelas) { loadQRCodeSiswa(nisn, nama, kelas); }

function openKelasDropdown() {
    const list = document.getElementById('dropdownKelasList');
    if (!list) return;
    renderDropdownItems(existingClasses);
    list.classList.remove('hidden');
}

function closeKelasDropdown() {
    setTimeout(() => { const list = document.getElementById('dropdownKelasList'); if(list) list.classList.add('hidden'); }, 200);
}

function filterKelasDropdown(query) {
    const list = document.getElementById('dropdownKelasList');
    if (!list) return;
    if (!query) { renderDropdownItems(existingClasses); return; }
    const filtered = existingClasses.filter(c => c.toLowerCase().includes(query.toLowerCase()));
    renderDropdownItems(filtered);
}

function renderDropdownItems(arr) {
    const list = document.getElementById('dropdownKelasList');
    if (!list) return;
    if (arr.length === 0) { list.innerHTML = '<div class="p-2 text-xs text-gray-400">Kelas tidak ditemukan</div>'; return; }
    list.innerHTML = arr.map(kelas => `<div onclick="selectKelasItem('${kelas}')" class="p-2 hover:bg-indigo-50 cursor-pointer text-sm text-gray-700 transition">${kelas}</div>`).join('');
}

function selectKelasItem(val) {
    const input = document.getElementById('inputKelas');
    if (input) input.value = val;
    closeKelasDropdown();
}

async function processDailyExportCustom(btnElement) {
    const tglDipilih = document.getElementById('tgl_export_harian').value;
    if (!tglDipilih) { showAlert('error', 'Pilih tanggal dulu!'); return; }
    
    let filterKelas = "";
    if (typeof currentUser !== 'undefined' && currentUser.role === 'guru' && currentUser.kelas) { filterKelas = currentUser.kelas; }

    const originalText = btnElement.innerHTML;
    btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    btnElement.disabled = true;

    try {
        const res = await fetchAPI('tarikDataExcelHarian', { tglString: tglDipilih, filterKelas: filterKelas });
        btnElement.innerHTML = originalText; btnElement.disabled = false;

        if (!res || !res.success) { showAlert('error', res ? res.message : 'Gagal mengambil data.'); return; }
        const data = res.data;
        if (!data || data.length === 0) { showAlert('warning', 'Tidak ada data absensi pada tanggal tersebut.'); return; }

        let headers = ["No", "NISN", "Nama Siswa", "Kelas", "Jam Datang", "Jam Pulang", "Status", "Keterangan"];
        let excelRows = [headers];

        data.forEach((row, idx) => {
            let jd = String(row.jamDatang || "-"); if(jd.length > 5) jd = jd.substring(0, 5);
            let jp = String(row.jamPulang || "-"); if(jp.length > 5) jp = jp.substring(0, 5);
            excelRows.push([idx + 1, row.nisn, row.nama, row.kelas, jd, jp, row.status, row.keterangan]);
        });

        const ws = XLSX.utils.aoa_to_sheet(excelRows);
        ws['!cols'] = [{wch:5}, {wch:15}, {wch:30}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:25}];
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Harian");
        
        const fileName = `Absensi_${tglDipilih}_${filterKelas || 'Semua'}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showAlert('success', 'Download Berhasil!');

    } catch(err) {
        btnElement.innerHTML = originalText; btnElement.disabled = false;
        showAlert('error', 'Koneksi Server Gagal: ' + err.message);
    }
}


// ============================================================
// LOGIKA KHUSUS MENU SISWA (PROFIL & REKAP PDF)
// ============================================================

async function showProfilSiswa() {
    showLoading();
    let dataSiswa = { 
        nama: currentUser.nama, nisn: currentUser.nisn, kelas: currentUser.kelas, 
        jenisKelamin: '-', tanggalLahir: '-' 
    };
    
    try {
        // Coba ambil data lengkap siswa dari server tanpa perlu endpoint baru
        const result = await fetchAPI('getSiswaList');
        if (result.success) {
            const findSiswa = result.data.find(s => s.nisn == currentUser.nisn);
            if (findSiswa) { dataSiswa = findSiswa; }
        }
    } catch(e) {}
    hideLoading();

    const modalContent = `
    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 max-w-[320px] w-full relative overflow-hidden animate-slide-up mx-auto mt-20 md:mt-0 border border-gray-100">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-rose-500 bg-gray-50 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fas fa-times"></i></button>

        <div class="text-center mb-6 mt-2">
            <div class="w-20 h-20 bg-gradient-to-br from-teal-400 to-emerald-500 text-white rounded-full flex items-center justify-center mx-auto mb-3 border-4 border-teal-50 shadow-md text-3xl">
                <i class="fas fa-user-graduate"></i>
            </div>
            <h3 class="font-bold text-lg text-gray-800 tracking-tight leading-tight">${dataSiswa.nama}</h3>
            <p class="text-[10px] font-bold text-teal-600 uppercase tracking-widest mt-1.5 bg-teal-50 inline-block px-3 py-1 rounded-full border border-teal-100">Profil Siswa</p>
        </div>

        <div class="space-y-2 mb-2">
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                <span class="text-[11px] font-bold text-gray-500 uppercase"><i class="far fa-id-card text-teal-500 w-4 text-center mr-1"></i> NISN</span>
                <span class="text-sm font-bold text-gray-800 font-mono">${dataSiswa.nisn}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                <span class="text-[11px] font-bold text-gray-500 uppercase"><i class="fas fa-chalkboard text-teal-500 w-4 text-center mr-1"></i> Kelas</span>
                <span class="text-sm font-bold text-gray-800">${dataSiswa.kelas}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                <span class="text-[11px] font-bold text-gray-500 uppercase"><i class="fas fa-venus-mars text-teal-500 w-4 text-center mr-1"></i> L/P</span>
                <span class="text-sm font-bold text-gray-800">${dataSiswa.jenisKelamin}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                <span class="text-[11px] font-bold text-gray-500 uppercase"><i class="fas fa-birthday-cake text-teal-500 w-4 text-center mr-1"></i> Lahir</span>
                <span class="text-sm font-bold text-gray-800">${dataSiswa.tanggalLahir || '-'}</span>
            </div>
        </div>
    </div>`;
    showModal(modalContent);
}

let rs_currentData = []; // Simpan data sementara untuk PDF

function loadRekapSiswa() {
    stopAndBack(false); setActiveMenu('Rekap Absen'); showView('view-rekap-siswa');
    
    const curDate = new Date();
    const yearInput = document.getElementById('rs_tahun');
    if(yearInput && !yearInput.value) yearInput.value = curDate.getFullYear();
    
    const monthSelect = document.getElementById('rs_bulan');
    if(monthSelect && monthSelect.options.length === 0) {
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        months.forEach((m, i) => { monthSelect.innerHTML += `<option value="${i+1}" ${i === curDate.getMonth() ? 'selected' : ''}>${m}</option>`; });
    }
    document.getElementById('rs_result').classList.add('hidden');
}

async function cariRekapSiswa() {
    const bln = document.getElementById('rs_bulan').value;
    const thn = document.getElementById('rs_tahun').value;
    if(!bln || !thn) return;

    document.getElementById('rs_result').classList.add('hidden');
    document.getElementById('rs_loading').classList.remove('hidden');

    const startStr = `${thn}-${String(bln).padStart(2,'0')}-01`;
    const lastDay = new Date(thn, bln, 0).getDate();
    const endStr = `${thn}-${String(bln).padStart(2,'0')}-${lastDay}`;

    try {
        const filter = { tanggalMulai: startStr, tanggalAkhir: endStr, kelas: currentUser.kelas };
        const res = await fetchAPI('getAbsensiList', { filter: filter });
        
        document.getElementById('rs_loading').classList.add('hidden');
        document.getElementById('rs_result').classList.remove('hidden');

        if(res.success) {
            // Saring agar hanya menampilkan absensi milik siswa yang sedang login
            rs_currentData = res.data.filter(d => d.nisn == currentUser.nisn);
            renderTabelRekapSiswa(rs_currentData);
        } else {
            rs_currentData = []; renderTabelRekapSiswa([]);
        }
    } catch(e) {
        document.getElementById('rs_loading').classList.add('hidden');
        showAlert('error', 'Gagal memuat rekap server.');
    }
}

function renderTabelRekapSiswa(data) {
    const tbody = document.getElementById('tbody-rekap-siswa');
    if(data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-5 text-center text-gray-400 italic">Tidak ada data kehadiran bulan ini.</td></tr>';
        return;
    }
    
    data.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));
    const getStatusColor = (s) => { 
        if(s === 'Hadir') return 'bg-green-100 text-green-700'; 
        if(s === 'Izin') return 'bg-blue-100 text-blue-700'; 
        if(s === 'Sakit') return 'bg-yellow-100 text-yellow-700'; 
        if(s === 'Alpa') return 'bg-red-100 text-red-700'; return 'bg-gray-100 text-gray-600'; 
    };

    tbody.innerHTML = data.map(d => {
        let ketText = d.keterangan || "-"; let ketStyle = "text-gray-500";
        if (String(ketText).includes("Terlambat")) ketStyle = "text-rose-600 font-bold";
        else if (String(ketText).includes("Pulang Cepat")) ketStyle = "text-orange-600 font-bold";
        else if (ketText === "Tepat Waktu") ketStyle = "text-emerald-600 font-bold";

        return `<tr class="hover:bg-gray-50 transition">
            <td class="p-3 text-center text-gray-700">${new Date(d.tanggal).toLocaleDateString('id-ID', {weekday:'short', day: 'numeric', month: 'short'})}</td>
            <td class="p-3 text-center"><span class="${getStatusColor(d.status)} px-2 py-1 rounded-lg text-[10px] font-bold">${d.status}</span></td>
            <td class="p-3 ${ketStyle}">${ketText}</td>
        </tr>`;
    }).join('');
}

async function downloadPDFRekapSiswa() {
    if(rs_currentData.length === 0) { showAlert('error', 'Tidak ada data untuk diunduh'); return; }
    
    const btn = document.getElementById('btnDownloadPDFSiswa');
    const originalTxt = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses PDF...'; btn.disabled = true;

    try {
        const blnText = document.getElementById('rs_bulan').options[document.getElementById('rs_bulan').selectedIndex].text;
        const thnText = document.getElementById('rs_tahun').value;
        
        // Ambil Data Kop Surat dari Header yang sudah terisi
        document.getElementById('printLogoSiswa').src = document.querySelector('.dyn-logo').src;
        document.getElementById('printNamaSekolah').textContent = document.querySelector('.dyn-namasekolah').textContent;
        document.getElementById('printProvinsi').textContent = document.querySelector('.dyn-provinsi').textContent;
        
        // Isi Identitas
        document.getElementById('printSiswaNama').textContent = currentUser.nama;
        document.getElementById('printSiswaNISN').textContent = currentUser.nisn;
        document.getElementById('printSiswaKelas').textContent = currentUser.kelas;
        document.getElementById('printSiswaPeriode').textContent = `${blnText} ${thnText}`;

        // Isi Tabel Print
        const tbodyPrint = document.getElementById('printTbodyRekapSiswa');
        tbodyPrint.innerHTML = rs_currentData.map((d, i) => `
            <tr>
                <td style="border: 1px solid #000; padding: 8px; text-align: center;">${i+1}</td>
                <td style="border: 1px solid #000; padding: 8px; text-align: center;">${new Date(d.tanggal).toLocaleDateString('id-ID', {weekday:'long', day: 'numeric', month: 'long', year: 'numeric'})}</td>
                <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${d.status}</td>
                <td style="border: 1px solid #000; padding: 8px;">${d.keterangan || '-'}</td>
            </tr>
        `).join('');

        const printArea = document.getElementById('printAreaRekapSiswa');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Render Element ke Gambar Resolusi Tinggi dengan paksaan lebar window Desktop
        const canvas = await html2canvas(printArea, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: "#ffffff",
            windowWidth: 800
        });
        const imgData = canvas.toDataURL('image/png');
        
        const pdfWidth = 210; 
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save(`Rekap_Absen_${currentUser.nama}_${blnText}_${thnText}.pdf`);
        
        showAlert('success', 'PDF Berhasil Diunduh!');
    } catch (error) {
        showAlert('error', 'Gagal membuat PDF. Coba kembali.');
    } finally {
        btn.innerHTML = originalTxt; btn.disabled = false;
    }
}

// ============================================================
// [BARU] LOGIKA UPLOAD & CROP LOGO 1:1
// ============================================================
let cropperInstance = null;

// Deteksi saat pengguna memilih file gambar
document.addEventListener("DOMContentLoaded", function() {
    const inputLogoFile = document.getElementById('inputLogoFile');
    if(inputLogoFile) {
        inputLogoFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validasi ukuran maksimal (Opsional: 2MB)
                if(file.size > 2 * 1024 * 1024) {
                    showAlert('error', 'Ukuran gambar maksimal 2MB!');
                    this.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    openCropModal(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

function openCropModal(imageSrc) {
    const modal = document.getElementById('cropModal');
    const image = document.getElementById('imageToCrop');
    
    // Tampilkan Modal
    modal.classList.remove('hidden');
    image.src = imageSrc;

    // Inisialisasi Cropper.js dengan Rasio 1:1
    if (cropperInstance) { cropperInstance.destroy(); }
    cropperInstance = new Cropper(image, {
        aspectRatio: 1 / 1, // Memaksa kotak 1:1
        viewMode: 1,        // Gambar tidak bisa keluar dari canvas
        background: false,  // Background transparan
        autoCropArea: 0.8,
        dragMode: 'move'
    });
}

function closeCropModal() {
    document.getElementById('cropModal').classList.add('hidden');
    if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
    document.getElementById('inputLogoFile').value = ''; // Reset input
}

function applyCrop() {
    if (!cropperInstance) return;
    
    // Dapatkan hasil crop sebagai Base64 PNG (Mempertahankan background transparan)
    const canvas = cropperInstance.getCroppedCanvas({
        width: 400, // Ukuran ideal untuk logo
        height: 400
    });
    
    const croppedBase64 = canvas.toDataURL('image/png');
    
    // Terapkan ke tampilan dan hidden input
    document.getElementById('previewLogoSetting').src = croppedBase64;
    document.getElementById('finalLogoData').value = croppedBase64;
    
    // Tutup modal
    closeCropModal();
}


document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById('tgl_export_harian');
    if (dateInput) {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0'); 
        const day = String(d.getDate()).padStart(2, '0');      
        dateInput.value = `${year}-${month}-${day}`;
    }
    
    // Inisialisasi App
    initAppConfigs();
    checkSession();
});
</script>
</body>
</html>
